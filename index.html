<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exness Auto-Trading Bot</title>
    
    <!-- Theme Color and PWA Meta -->
    <meta name="theme-color" content="#0D1321">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Manifest link tag will be dynamically generated by the PWA script below -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- TradingView Widget Script -->
    <script src="https://s3.tradingview.com/tv.js"></script>

    <style>
        /* --- Base Dark Mode Theme (Exness Inspired) --- */
        :root {
            --primary-bg: #0D1321; /* Dark background */
            --secondary-bg: #1A2744; /* Card/section background (dark blue/purple) */
            --primary-text: #E5E7EB; /* Light text */
            --accent-color: #00A65A; /* Exness Green Accent */
            --muted-text: #9CA3AF;
            --danger-red: #EF4444;
            --success-green: #10B981;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--primary-text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Responsive Container */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Custom Scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1A2744;
        }
        ::-webkit-scrollbar-thumb {
            background: #00A65A;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00CC66;
        }
    </style>
</head>
<body class="bg-[var(--primary-bg)]">
    <div id="root"></div>

    <!-- 
    ===================================================================
    PWA Installation Logic (Adapted from provided JavaScript)
    Handles Service Worker Registration, Manifest Injection, and Install Prompt
    =================================================================== 
    -->
    <script>
        // Use global variables for PWA configuration
        const CACHE_NAME = 'exness-auto-bot-v1';
        const PRECACHE_URLS = ['/', '/index.html', '/AI-Trading-Bot.html'];
        const APP_NAME = 'Exness Auto-Trading Bot';
        const APP_SHORT_NAME = 'Exness';
        const THEME_COLOR = '#0D1321';
        const BACKGROUND_COLOR = '#0D1321';
        // Placeholder Icon URL for Exness Logo PNG (as a specific URL was not provided)
        const ICON_PNG_URL = 'https://placehold.co/512x512/0D1321/00A65A?text=EXNESS'; 
        
        let deferredPrompt = null;
        let isAppInstalled = false;
        let manifestBlobUrl = null;
        let swRegistration = null;
        
        // --- Small DOM helpers ---
        function $ (id) { return document.getElementById(id); }
        function createEl (tag, props = {}, children = []) {
            const el = document.createElement(tag);
            Object.keys(props).forEach(k => {
                if (k === 'style') Object.assign(el.style, props[k]);
                else if (k === 'attrs') Object.keys(props.attrs).forEach(a => el.setAttribute(a, props.attrs[a]));
                else el[k] = props[k];
            });
            (Array.isArray(children) ? children : [children]).forEach(c => {
                if (typeof c === 'string') el.appendChild(document.createTextNode(c));
                else if (c) el.appendChild(c);
            });
            return el;
        }

        // --- Create or update the manifest ---
        function ensureManifest() {
            try {
                const existing = document.querySelector('link[rel="manifest"]');
                if (existing) existing.parentNode.removeChild(existing); 

                const manifest = {
                    name: APP_NAME,
                    short_name: APP_SHORT_NAME,
                    start_url: '/index.html',
                    scope: '/',
                    display: 'standalone',
                    orientation: 'portrait',
                    theme_color: THEME_COLOR,
                    background_color: BACKGROUND_COLOR,
                    icons: [
                        { src: ICON_PNG_URL, sizes: '192x192', type: 'image/png', purpose: 'any' },
                        { src: ICON_PNG_URL, sizes: '512x512', type: 'image/png', purpose: 'maskable any' }
                    ],
                    description: 'Automated trading bot for Exness portfolio management.'
                }; 

                const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                manifestBlobUrl = URL.createObjectURL(blob);
                const link = createEl('link', { attrs: { rel: 'manifest', href: manifestBlobUrl }});
                document.head.appendChild(link);
                console.info('PWA manifest injected/updated with PNG icon.');
            } catch (err) {
                console.error('Failed to create manifest:', err);
            }
        } 

        // --- Service Worker registration (Inline fallback) ---
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.warn('Service Worker not supported.');
                return null;
            } 

            // Inline worker: caches the required resources
            const swCode = `
                const CACHE_NAME = '${CACHE_NAME}';
                const PRECACHE = ${JSON.stringify(PRECACHE_URLS)}; 

                self.addEventListener('install', (evt) => {
                    evt.waitUntil((async () => {
                        try {
                            const c = await caches.open(CACHE_NAME);
                            await c.addAll(PRECACHE);
                            console.log('Precache successful:', PRECACHE);
                        } catch (e) {
                            console.error('Precache failed:', e);
                        }
                        self.skipWaiting();
                    })());
                }); 

                self.addEventListener('activate', (evt) => {
                    evt.waitUntil((async () => {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(k => k === CACHE_NAME ? Promise.resolve() : caches.delete(k)));
                        await self.clients.claim();
                    })());
                }); 

                self.addEventListener('fetch', (evt) => {
                    evt.respondWith((async () => {
                        try {
                            const cache = await caches.open(CACHE_NAME);
                            const cached = await cache.match(evt.request);
                            if (cached) return cached;
                            const response = await fetch(evt.request);
                            if (evt.request.method === 'GET' && response && response.status === 200 && evt.request.url.startsWith(self.location.origin)) {
                                cache.put(evt.request, response.clone()).catch(()=>{});
                            }
                            return response;
                        } catch (err) {
                            // Fallback for navigation requests when offline
                            if (evt.request.mode === 'navigate') {
                                const cache = await caches.open(CACHE_NAME);
                                // Fallback to index.html if offline
                                const fallback = await cache.match('/index.html');
                                if (fallback) return fallback;
                            }
                            return new Response('Offline', { status: 503, statusText: 'Offline' });
                        }
                    })());
                }); 

                self.addEventListener('message', async (evt) => {
                    const data = evt.data || {};
                    if (data && data.type === 'CACHE_URLS' && Array.isArray(data.urls)) {
                        try {
                            const cache = await caches.open(CACHE_NAME);
                            await cache.addAll(data.urls);
                            const cs = await self.clients.matchAll();
                            cs.forEach(c => c.postMessage({ type: 'cached', urls: data.urls }));
                        } catch (e) {
                            const cs = await self.clients.matchAll();
                            cs.forEach(c => c.postMessage({ type: 'cache_failed', error: String(e) }));
                        }
                    }
                });
            `; 

            try {
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const blobUrl = URL.createObjectURL(blob);
                const reg = await navigator.serviceWorker.register(blobUrl, { scope: '/' });
                swRegistration = reg;
                console.info('Inline Service Worker registered.');
                return swRegistration;
            } catch (err) {
                console.error('Failed to register inline Service Worker:', err);
                return null;
            }
        } 

        function waitForAppInstalledOrTimeout(timeoutMs = 15000) {
            return new Promise((resolve) => {
                if (isAppInstalled) return resolve();
                let done = false;
                function onInstalled() {
                    if (done) return;
                    done = true;
                    window.removeEventListener('appinstalled', onInstalled);
                    resolve();
                }
                window.addEventListener('appinstalled', onInstalled);
                setTimeout(() => {
                    if (done) return;
                    done = true;
                    window.removeEventListener('appinstalled', onInstalled);
                    resolve();
                }, timeoutMs);
            });
        } 

        async function cacheResourcesFromPage(urls = PRECACHE_URLS) {
            if (!('caches' in window)) {
                console.warn('Cache API not available.');
                return false;
            }
            try {
                const cache = await caches.open(CACHE_NAME);
                const toCache = Array.from(new Set((urls || []).filter(u => typeof u === 'string')));
                await cache.addAll(toCache);
                console.info('Resources cached via Cache API:', toCache);
                return true;
            } catch (err) {
                console.warn('Failed to cache resources via page:', err);
                return false;
            }
        } 

        function updateProgressUI(progress = 0, text = 'Processing...') {
            const progressBar = $('pwa-install-progress-bar');
            const progressText = $('pwa-install-progress-text');
            const progressContainer = $('pwa-install-progress');

            if (progressContainer) progressContainer.style.display = 'block';
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.innerText = text;
        }

        function finalizeInstallUI(success = true, extraText = '') {
            const installBtn = $('install-now-btn');
            const cancelBtn = $('cancel-install-btn');
            const progressText = $('pwa-install-progress-text'); 

            if (installBtn) {
                installBtn.innerText = success ? 'App installed' : 'Install Failed';
                installBtn.disabled = true;
                installBtn.style.background = success ? 'var(--accent-color)' : 'var(--danger-red)';
                installBtn.style.color = success ? 'var(--primary-bg)' : 'var(--primary-text)';
            }
            if (cancelBtn) cancelBtn.disabled = false;
            if (progressText) progressText.innerText = success ? `Installation Complete! App added to Home Screen${extraText ? ' — ' + extraText : ''}` : 'Installation failed. Try refreshing the page.';
            isAppInstalled = !!success; 

            // Show a short success toast
            try {
                const toast = createEl('div', { innerText: success ? `${APP_NAME} installed!` : 'Install failed', style: {
                    position: 'fixed', right: '16px', bottom: '16px', background: success ? 'var(--accent-color)' : 'var(--danger-red)', color: success ? 'var(--primary-bg)' : 'var(--primary-text)', padding: '10px 14px', borderRadius: '10px', zIndex: 2147483648, boxShadow: '0 6px 20px rgba(0,0,0,0.4)'
                }});
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3500);
            } catch (e) {} 

            // Close modal shortly
            setTimeout(window.pwaInstaller.hideInstallModal, 3000);
        } 

        // --- Install flow: triggered when "Install Now" clicked ---
        async function onInstallNowClicked(e) {
            e && e.preventDefault && e.preventDefault(); 

            const installBtn = $('install-now-btn');
            const cancelBtn = $('cancel-install-btn');

            if (installBtn) { 
                installBtn.disabled = true; 
                installBtn.style.opacity = '0.8'; 
                installBtn.innerText = 'Starting Install...'; 
                installBtn.style.background = '#374151'; // Gray out
                installBtn.style.color = 'var(--primary-text)';
            }
            if (cancelBtn) cancelBtn.disabled = true; 
            updateProgressUI(5, 'Preparing installation environment...');

            // If native install prompt available, prefer that
            if (deferredPrompt) {
                try {
                    deferredPrompt.prompt();
                    const choice = await deferredPrompt.userChoice;
                    deferredPrompt = null; // only usable once
                    
                    if (choice.outcome === 'accepted') {
                        updateProgressUI(40, 'User accepted native prompt. Downloading App files...');
                        // Wait for appinstalled event to fire, or timeout
                        await waitForAppInstalledOrTimeout(12000); 
                        // Ensure all files are aggressively cached post-install
                        await ensureSWAndCacheWithProgress();
                        finalizeInstallUI(true);
                        return;
                    } 
                    // If dismissed, continue with aggressive fallback caching
                } catch (err) {
                    console.warn('deferredPrompt.prompt() error or dismissal', err);
                }
            } 
            
            // Aggressive fallback caching sequence
            updateProgressUI(10, 'Registering Service Worker for offline support...');
            await fallbackInstallSequence();
            finalizeInstallUI(true, 'Offline files cached');
        } 

        async function fallbackInstallSequence() {
            try {
                const reg = swRegistration || await registerServiceWorker();
                if (reg && reg.active) {
                    updateProgressUI(35, 'Service Worker registered. Caching essential files...');
                    // Ask SW to cache resources
                    reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS });
                    await new Promise(r => setTimeout(r, 1000)); // Simulate work
                    // Also attempt page-side caching to be robust
                    await cacheResourcesFromPage(PRECACHE_URLS);
                    updateProgressUI(90, 'App files cached. Finalizing installation...');
                    await new Promise(r => setTimeout(r, 1000));
                } else {
                    // No SW active: fallback to using Cache API only
                    updateProgressUI(50, 'Service Worker unavailable. Caching app resources via browser API...');
                    await cacheResourcesFromPage(PRECACHE_URLS);
                    updateProgressUI(95, 'App files cached. Finalizing installation...');
                    await new Promise(r => setTimeout(r, 800));
                }
            } catch (err) {
                console.error('fallbackInstallSequence error:', err);
                updateProgressUI(100, 'Installation encountered issues — offline may be limited.', '#EF4444');
            }
        } 

        // Helper to ensure SW is registered and caches resources (used after native install)
        async function ensureSWAndCacheWithProgress() {
            try {
                const reg = swRegistration || await registerServiceWorker();
                if (reg && reg.active) {
                    updateProgressUI(70, 'Ensuring all app files are cached...');
                    reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS });
                    await cacheResourcesFromPage(PRECACHE_URLS);
                    updateProgressUI(95, 'Cache synchronization complete.');
                    return true;
                }
            } catch (e) {
                console.warn('Post-install caching failed.', e);
                return false;
            }
        }

        // --- Initialization on DOM ready ---
        function initPWA() {
            ensureManifest(); 
            registerServiceWorker(); // Register SW immediately in the background

            // Listen for beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.info('beforeinstallprompt captured.');
                // Trigger React state update to show prompt buttons
                if (window.showInstallPromptGlobally) {
                    window.showInstallPromptGlobally(true);
                }
            }); 

            // App installed event
            window.addEventListener('appinstalled', (evt) => {
                console.info('PWA installed event received.');
                isAppInstalled = true;
                if (window.showInstallPromptGlobally) {
                    window.showInstallPromptGlobally(false);
                }
                finalizeInstallUI(true);
            }); 
            
            // Expose PWA functions for React to use
            window.pwaInstaller = {
                showInstallModal: () => {
                     // The modal UI is handled by the React component, 
                     // so we just trigger the state update
                     if (window.showInstallPromptGlobally) {
                         window.showInstallPromptGlobally(true);
                     }
                },
                hideInstallModal: () => {
                    if (window.showInstallPromptGlobally) {
                        window.showInstallPromptGlobally(false);
                    }
                },
                onInstallNowClicked,
                isInstallAvailable: () => !!deferredPrompt,
                isAppInstalled: () => isAppInstalled
            };

            // Hook common buttons to the PWA prompt logic
            function setupGetAppButtons() {
                const handler = (e) => {
                    e && e.preventDefault && e.preventDefault();
                    if (window.pwaInstaller) {
                        window.pwaInstaller.showInstallModal();
                    }
                };
                const ids = ['get-app-btn', 'get-mobile-app', 'getAppButton', 'get-app'];
                ids.forEach(id => {
                    const el = $(id) || document.querySelector(`#${id}`);
                    if (el) { el.addEventListener('click', handler); }
                });
            }

            // Must run after React mounts the buttons
            setTimeout(setupGetAppButtons, 1000); 
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPWA);
        } else {
            initPWA();
        } 
    </script>


    <!-- 
    ===================================================================
    React/Babel Application (Single Component File)
    =================================================================== 
    -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const root = ReactDOM.createRoot(document.getElementById('root'));

        // --- Constants ---
        const COINGECKO_API = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false';
        const EXNESS_LOGO_URL = 'https://placehold.co/40x40/0D1321/00A65A?text=EX'; 

        // --- Custom Hook for PWA Install State (Connects React to global PWA logic) ---
        function usePWAInstall() {
            const [showPrompt, setShowPrompt] = useState(false);
            
            // Expose function globally for the PWA script to call
            useEffect(() => {
                window.showInstallPromptGlobally = setShowPrompt;
                return () => {
                    window.showInstallPromptGlobally = null;
                };
            }, []);

            return { showPrompt, setShowPrompt };
        }

        // --- Components ---

        // 1. Loading and Redirection Handler
        const LoadingOverlay = ({ visible, onComplete }) => {
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                if (visible) {
                    setProgress(0);
                    const startTime = Date.now();
                    const duration = 15000; // 15 seconds

                    const interval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const newProgress = Math.min(100, (elapsed / duration) * 100);
                        setProgress(newProgress);

                        if (newProgress >= 100) {
                            clearInterval(interval);
                            if (onComplete) onComplete();
                        }
                    }, 50);

                    return () => clearInterval(interval);
                }
            }, [visible, onComplete]);

            if (!visible) return null;

            return (
                <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black bg-opacity-90">
                    <div className="w-64">
                        <h2 className="text-xl font-bold mb-4 text-center text-white">Connecting to AI Bot...</h2>
                        <div className="bg-gray-700 h-2.5 rounded-full overflow-hidden">
                            <div 
                                className="bg-[var(--accent-color)] h-2.5 transition-all duration-100 ease-linear"
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>
                        <p className="text-sm mt-3 text-center text-[var(--muted-text)]">
                            Establishing secure connection ({Math.floor(progress)}%)...
                        </p>
                    </div>
                </div>
            );
        };

        // 2. Navigation Header
        const Header = ({ onShowPanel }) => (
            <header className="sticky top-0 z-20 bg-[var(--primary-bg)] bg-opacity-95 backdrop-blur-sm shadow-xl p-4 border-b border-[var(--secondary-bg)]">
                <div className="container flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                        <img src={EXNESS_LOGO_URL} alt="Exness Logo" className="w-8 h-8 rounded-md" />
                        <span className="text-xl font-extrabold text-[var(--accent-color)]">Exness</span>
                        <span className="hidden sm:inline text-xl font-semibold">Auto-Trading Bot</span>
                    </div>

                    <nav className="hidden lg:flex space-x-6 items-center">
                        <button className="text-sm font-semibold text-[var(--muted-text)] hover:text-[var(--accent-color)] transition">Markets</button>
                        <button className="text-sm font-semibold text-[var(--muted-text)] hover:text-[var(--accent-color)] transition">Performance</button>
                        <button className="text-sm font-semibold text-[var(--muted-text)] hover:text-[var(--accent-color)] transition">Strategy</button>
                        <button id="getAppButton" className="py-2 px-4 text-sm font-bold rounded-xl bg-gray-700 text-white hover:bg-gray-600 transition">
                            Get Mobile App
                        </button>
                    </nav>

                    <div className="lg:hidden">
                        <button 
                            onClick={onShowPanel}
                            className="p-2 rounded-xl bg-[var(--secondary-bg)] hover:bg-gray-700 transition"
                            aria-label="More options"
                        >
                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                    </div>
                </div>
            </header>
        );

        // 3. More Options Panel (Mobile/Dropdown)
        const MoreOptionsPanel = ({ onAction, onClose, isVisible }) => {
            const panelRef = useRef(null);

            const handleOutsideClick = useCallback((event) => {
                if (panelRef.current && !panelRef.current.contains(event.target)) {
                    onClose();
                }
            }, [onClose]);

            useEffect(() => {
                if (isVisible) {
                    document.addEventListener('mousedown', handleOutsideClick);
                } else {
                    document.removeEventListener('mousedown', handleOutsideClick);
                }
                return () => {
                    document.removeEventListener('mousedown', handleOutsideClick);
                };
            }, [isVisible, handleOutsideClick]);

            if (!isVisible) return null;

            const buttons = [
                { label: "Connect Portfolio", action: () => onAction('connect') },
                { label: "Login ID", action: () => onAction('login') },
                { label: "Support", action: () => alert('Opening Support Chat...') },
                { label: "Connect Wallet", action: () => alert('Wallet Connection Initiated...') },
                { label: "Start Free Trial", action: () => onAction('trial') },
            ];

            return (
                <div className="absolute right-4 top-16 lg:hidden z-30">
                    <div ref={panelRef} className="bg-[var(--secondary-bg)] p-4 rounded-xl shadow-2xl border border-gray-700 w-56">
                        {buttons.map((btn, index) => (
                            <button
                                key={index}
                                onClick={() => { btn.action(); onClose(); }}
                                className="block w-full text-left py-3 px-3 text-sm font-semibold text-[var(--primary-text)] hover:bg-gray-700 rounded-lg transition"
                            >
                                {btn.label}
                            </button>
                        ))}
                         <button
                            id="getAppButton-mobile"
                            onClick={() => { 
                                if (window.pwaInstaller) window.pwaInstaller.showInstallModal();
                                onClose(); 
                            }}
                            className="mt-3 w-full py-2 text-sm font-bold rounded-xl bg-[var(--accent-color)] text-[var(--primary-bg)] hover:bg-opacity-90 transition"
                        >
                            Get Mobile App
                        </button>
                    </div>
                </div>
            );
        };

        // 4. Market Data Display
        const MarketDataDisplay = ({ data, onSelectCoin }) => (
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-[var(--secondary-bg)]">
                        <tr>
                            <th className="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-[var(--muted-text)] rounded-tl-xl sm:rounded-tl-none">#</th>
                            <th className="py-3 px-4 text-left text-xs font-medium uppercase tracking-wider text-[var(--muted-text)]">Coin</th>
                            <th className="py-3 px-4 text-right text-xs font-medium uppercase tracking-wider text-[var(--muted-text)]">Price (USD)</th>
                            <th className="py-3 px-4 text-right text-xs font-medium uppercase tracking-wider text-[var(--muted-text)] rounded-tr-xl sm:rounded-tr-none">24h %</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-700">
                        {data.map((coin, index) => {
                            const changeColor = coin.price_change_percentage_24h >= 0 ? 'text-green-500' : 'text-red-500';
                            return (
                                <tr key={coin.id} 
                                    className="bg-[var(--primary-bg)] hover:bg-[var(--secondary-bg)] transition duration-200 cursor-pointer"
                                    onClick={() => onSelectCoin(coin.symbol.toUpperCase())}
                                >
                                    <td className="py-4 px-4 whitespace-nowrap text-sm font-medium">{index + 1}</td>
                                    <td className="py-4 px-4 whitespace-nowrap text-sm font-medium">
                                        <div className="flex items-center">
                                            <img src={coin.image} alt={coin.name} className="w-5 h-5 mr-2" />
                                            {coin.name} <span className="ml-2 text-[var(--muted-text)] uppercase">({coin.symbol})</span>
                                        </div>
                                    </td>
                                    <td className="py-4 px-4 whitespace-nowrap text-sm text-right">${coin.current_price.toLocaleString()}</td>
                                    <td className={`py-4 px-4 whitespace-nowrap text-sm font-semibold text-right ${changeColor}`}>
                                        {coin.price_change_percentage_24h.toFixed(2)}%
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );

        // 5. Global Footer
        const Footer = () => (
            <footer className="bg-[var(--secondary-bg)] p-8 mt-12">
                <div className="container text-center">
                    <p className="text-lg font-semibold text-[var(--accent-color)]">Exness Auto-Trading Bot</p>
                    <p className="text-sm mt-2 text-[var(--muted-text)]">Trade smart, not hard. Fully automated, fully transparent.</p>
                    <div className="mt-4 space-x-4">
                        <a href="#" className="text-sm text-[var(--muted-text)] hover:text-white transition">Privacy Policy</a>
                        <a href="#" className="text-sm text-[var(--muted-text)] hover:text-white transition">Terms of Service</a>
                        <button id="get-app-btn" className="text-sm text-[var(--accent-color)] hover:text-white transition font-bold">Get App</button>
                    </div>
                    <p className="text-xs mt-4 text-gray-600">© {new Date().getFullYear()} Exness Global. Trading carries a high risk of capital loss.</p>
                </div>
            </footer>
        );

        // 6. PWA Install Prompt (JSX implementation of the required UI)
        const InstallPrompt = ({ show, onInstall, onDismiss }) => {
            if (!show) return null;
            
            // This is the card element implemented in the PWA JS, but controlled by React state
            const Card = () => (
                <div id="pwa-install-modal-card" className="w-[380px] max-w-[94%] bg-[#1E2329] rounded-xl p-6 shadow-2xl text-white border border-[#2B3139]">
                    {/* Header Row */}
                    <div className="flex items-center gap-3 mb-3">
                        <img 
                            src={ICON_PNG_URL} 
                            alt="App Icon" 
                            className="w-12 h-12 rounded-lg object-cover border border-gray-700" 
                        />
                        <div>
                            <div className="text-xl font-bold text-[var(--accent-color)]">Install App</div>
                            <div className="text-sm text-[var(--primary-text)]">{APP_NAME}</div>
                        </div>
                    </div>

                    {/* Description */}
                    <div className="text-sm mt-3 text-[var(--muted-text)]">
                        Install Blockchain Auto-Trading Bot for the best experience! Get offline support and faster access.
                    </div>

                    {/* Progress Container (Hidden initially) */}
                    <div id="pwa-install-progress" className="mt-4 hidden">
                        <div className="w-full h-2 rounded-full bg-gray-700 overflow-hidden border border-gray-600">
                            <div id="pwa-install-progress-bar" className="h-full bg-[var(--accent-color)] transition-all duration-300 ease-in-out" style={{ width: '0%' }}></div>
                        </div>
                        <div id="pwa-install-progress-text" className="text-sm mt-2 text-[var(--muted-text)]">Ready to install</div>
                    </div>

                    {/* Actions */}
                    <div className="flex gap-3 justify-end mt-5">
                        <button 
                            onClick={onDismiss} 
                            className="py-2 px-4 text-sm font-semibold rounded-xl bg-gray-700 text-white hover:bg-gray-600 transition"
                        >
                            Maybe Later
                        </button>
                        <button 
                            id="install-now-btn" 
                            onClick={onInstall}
                            className="py-2 px-5 text-sm font-extrabold rounded-xl bg-[var(--accent-color)] text-[var(--primary-bg)] hover:bg-opacity-90 transition"
                        >
                            Install Now
                        </button>
                    </div>
                </div>
            );

            return (
                <div id="pwa-install-modal" className="fixed inset-0 z-[2147483647] flex items-center justify-center bg-black bg-opacity-60">
                    <Card />
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [marketData, setMarketData] = useState([]);
            const [selectedSymbol, setSelectedSymbol] = useState('BTC'); // Default
            const [showLoading, setShowLoading] = useState(false);
            const [showPanel, setShowPanel] = useState(false);
            const { showPrompt, setShowPrompt } = usePWAInstall();

            // Handle Navigation/Action (15-second delay + redirect)
            const handleAction = (type) => {
                setShowLoading(true);
            };

            const handleLoadingComplete = () => {
                setShowLoading(false);
                // Redirect requirement
                window.location.href = '/AI-Trading-Bot.html';
            };

            // Fetch Market Data
            const fetchMarketData = async () => {
                try {
                    const response = await fetch(COINGECKO_API);
                    const data = await response.json();
                    setMarketData(data);
                    // Set default symbol to the top coin if none selected
                    if (!selectedSymbol && data.length > 0) {
                        setSelectedSymbol(data[0].symbol.toUpperCase());
                    }
                } catch (error) {
                    console.error("Failed to fetch market data:", error);
                }
            };

            useEffect(() => {
                fetchMarketData();
                const interval = setInterval(fetchMarketData, 30000); // Update every 30 seconds
                return () => clearInterval(interval);
            }, []);

            // Initialize TradingView Widget
            const loadTradingViewWidget = (symbol) => {
                if (!window.TradingView) return;

                const container = document.getElementById('tradingview-widget-container');
                if (!container) return;

                // Clear existing content
                container.innerHTML = ''; 

                new window.TradingView.widget(
                    {
                        "autosize": true,
                        "symbol": `BINANCE:${symbol}USD`,
                        "interval": "D",
                        "timezone": "Etc/UTC",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "toolbar_bg": "var(--secondary-bg)",
                        "enable_publishing": false,
                        "hide_side_toolbar": false,
                        "allow_symbol_change": true,
                        "studies": [
                            "ROC@tv-basicstudies",
                            "StochasticRSI@tv-basicstudies"
                        ],
                        "container_id": "tradingview-widget-container"
                    }
                );
            };

            // Load TradingView when selected symbol changes
            useEffect(() => {
                if (selectedSymbol) {
                    // Timeout ensures the TradingView script has loaded
                    setTimeout(() => loadTradingViewWidget(selectedSymbol), 500); 
                }
            }, [selectedSymbol]);
            
            const handleInstallNow = () => {
                if (window.pwaInstaller && window.pwaInstaller.onInstallNowClicked) {
                    // Call the global PWA install function
                    window.pwaInstaller.onInstallNowClicked();
                } else {
                    alert("Installation logic not fully loaded. Try refreshing.");
                    setShowPrompt(false);
                }
            };

            return (
                <div className="min-h-screen">
                    <Header onShowPanel={() => setShowPanel(true)} />
                    <MoreOptionsPanel 
                        isVisible={showPanel} 
                        onClose={() => setShowPanel(false)} 
                        onAction={(type) => handleAction(type)} 
                    />

                    {/* Main Content */}
                    <main className="container pt-8 pb-16">
                        
                        {/* Hero Section */}
                        <section className="text-center py-16 px-4 md:px-0 bg-[var(--primary-bg)]">
                            <h1 className="text-4xl sm:text-6xl font-extrabold leading-tight text-[var(--primary-text)]">
                                <span className="text-[var(--accent-color)]">AI-Powered</span> Trading Made Simple
                            </h1>
                            <p className="mt-4 text-lg sm:text-xl text-[var(--muted-text)] max-w-3xl mx-auto">
                                The Exness Auto-Trading Bot leverages advanced deep learning models to execute high-frequency trades across major crypto and forex markets, maximizing returns while minimizing risk exposure. Disrupting the market with precision.
                            </p>
                            <div className="mt-8 space-y-4 sm:space-y-0 sm:space-x-6">
                                <button 
                                    onClick={() => handleAction('connect')} 
                                    className="w-full sm:w-auto py-3 px-8 text-lg font-bold rounded-xl shadow-xl bg-[var(--accent-color)] text-[var(--primary-bg)] hover:bg-opacity-90 transition transform hover:scale-[1.02]"
                                >
                                    Connect Portfolio
                                </button>
                                <button 
                                    onClick={() => handleAction('trial')} 
                                    className="w-full sm:w-auto py-3 px-8 text-lg font-bold rounded-xl shadow-xl border border-[var(--accent-color)] text-[var(--accent-color)] hover:bg-[var(--accent-color)] hover:text-[var(--primary-bg)] transition transform hover:scale-[1.02]"
                                >
                                    Start Free Trial
                                </button>
                            </div>
                            <div className="mt-4">
                                <button 
                                    onClick={() => handleAction('login')}
                                    className="text-sm font-semibold text-[var(--muted-text)] hover:text-white transition"
                                >
                                    Already a user? <span className="text-blue-400">Login ID</span>
                                </button>
                            </div>
                        </section>

                        {/* Market Overview & TradingView */}
                        <section className="mt-12">
                            <h2 className="text-3xl font-bold mb-6 text-center">Live Market Data & Strategy Overview</h2>
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                
                                {/* TradingView Chart */}
                                <div className="lg:col-span-2 bg-[var(--secondary-bg)] p-4 rounded-xl shadow-2xl h-80 mb-12">
                                    <div id="tradingview-widget-container" className="h-full">
                                        {/* TradingView widget loads here */}
                                        <div className="text-center text-[var(--muted-text)] pt-16">Loading Live Price Chart for {selectedSymbol}...</div>
                                    </div>
                                </div>

                                {/* Top Coins List */}
                                <div className="lg:col-span-1 bg-[var(--secondary-bg)] p-4 rounded-xl shadow-2xl overflow-y-auto max-h-[500px]">
                                    <h4 className="text-xl font-semibold mb-4 border-b border-gray-700 pb-3">Top 10 Cryptocurrencies</h4>
                                    {marketData.length > 0 ? (
                                        <MarketDataDisplay 
                                            data={marketData} 
                                            onSelectCoin={(symbol) => setSelectedSymbol(symbol)} 
                                        />
                                    ) : (
                                        <p className="text-[var(--muted-text)]">Loading market data...</p>
                                    )}
                                </div>

                            </div>
                        </section>
                        
                    </main>
                    <Footer />
                    
                    <LoadingOverlay visible={showLoading} onComplete={handleLoadingComplete} />
                    
                    <InstallPrompt 
                        show={showPrompt}
                        onInstall={handleInstallNow}
                        onDismiss={() => setShowPrompt(false)}
                    />
                </div>
            );
        };

        // Render the App
        root.render(<App />);

    </script>
</body>
</html>
