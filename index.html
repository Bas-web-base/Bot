<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Exness Auto-Trading Bot</title>
  <meta name="theme-color" content="#0D1321" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            exness_bg: '#0D1321',
            exness_card: '#1A2744',
            exness_text: '#E5E7EB',
            exness_accent: '#00A389',
            exness_hover: '#00C4A4',
            exness_border: '#1E3557',
            exness_muted: '#9CA3AF'
          },
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] }
        }
      }
    }
  </script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0D1321;
      --card: #1A2744;
      --text: #E5E7EB;
      --accent: #00A389;
      --muted: #9CA3AF;
      --border: #1E3557;
    }
    html,body { height:100%; }
    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Buttons */
    .btn-primary { background:var(--accent); color:var(--bg); padding:10px 16px; border-radius:12px; font-weight:700; }
    .btn-primary:hover { background: #00bd9c; transform: translateY(-1px); }
    .btn-secondary { background:transparent; border:1px solid var(--accent); color:var(--accent); padding:8px 14px; border-radius:12px; font-weight:600; }

    /* Install modal */
    #pwa-install-modal { display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:9999; }
    #pwa-install-card { width:420px; max-width:94%; background:var(--card); border-radius:14px; padding:20px; box-shadow:0 10px 40px rgba(0,0,0,0.6); border:1px solid var(--border); }

    /* Loading overlay for redirects */
    #loading-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9000; background:rgba(2,6,23,0.8); color:var(--text); flex-direction:column; gap:14px; }
    #loading-overlay.active { display:flex; }
    .loader { border:4px solid rgba(255,255,255,0.06); border-top:4px solid var(--accent); border-radius:50%; width:44px; height:44px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Simple responsive container */
    .container { max-width:1100px; margin:0 auto; padding:16px; }

    /* Header */
    header.app-header { position:sticky; top:0; z-index:40; background:linear-gradient(180deg, rgba(13,19,33,0.9), rgba(13,19,33,0.6)); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(255,255,255,0.02); }

    /* Market row */
    .market-card { background: linear-gradient(180deg, rgba(26,39,68,0.5), rgba(13,19,33,0.25)); border-radius:12px; padding:12px; border:1px solid var(--border); }

    /* Footer */
    footer.site-footer { border-top:1px solid rgba(255,255,255,0.02); padding:18px 0; background:transparent; color:var(--muted); position:relative; }

    /* small helper */
    .muted { color:var(--muted); font-size:0.95rem; }

    /* responsive */
    @media (max-width:640px) {
      .header-actions { gap:8px; }
    }
  </style>

  <!-- TradingView script (will be embedded later for charts per coin) -->
  <script src="https://s3.tradingview.com/tv.js"></script>

</head>
<body>

  <!-- Loading overlay used for 15s loads and redirects -->
  <div id="loading-overlay" aria-hidden="true">
    <div class="loader" role="status" aria-label="Loading"></div>
    <div id="loading-text">Preparing AI Trading Bot…</div>
    <div class="muted">This may take up to 15 seconds.</div>
  </div>

  <!-- PWA Install Modal -->
  <div id="pwa-install-modal" role="dialog" aria-modal="true">
    <div id="pwa-install-card">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <img id="exness-pwa-logo" src="https://my.exness-static.com/cdn-cgi/image/width=300,height=300,format=auto/brand-assets/exness-logo.png" alt="Exness" style="width:52px;height:52px;border-radius:10px;object-fit:cover;border:2px solid var(--accent)"/>
        <div>
          <div style="font-weight:800;font-size:18px;color:var(--accent)">Install Exness Auto-Trading Bot</div>
          <div class="muted" style="font-size:13px;margin-top:4px">Install the full Progressive Web App for faster loading, offline support, and a home-screen icon.</div>
        </div>
      </div>

      <div id="pwa-install-progress" style="display:none;margin-top:12px">
        <div style="width:100%;height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)">
          <div id="pwa-install-progress-bar" style="width:0%;height:100%;background:var(--accent);transition:width 300ms ease"></div>
        </div>
        <div id="pwa-install-progress-text" class="muted" style="margin-top:8px;font-size:13px">Ready to install</div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:16px">
        <button id="cancel-install-btn" class="btn-secondary">Maybe Later</button>
        <button id="install-now-btn" class="btn-primary">Install Now</button>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <header class="app-header">
    <div class="container flex items-center justify-between py-4">
      <div style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="goToLanding()">
        <img src="https://my.exness-static.com/cdn-cgi/image/width=300,height=300,format=auto/brand-assets/exness-logo.png" alt="Exness" style="width:40px;height:40px;object-fit:cover;border-radius:8px"/>
        <div style="font-weight:700;font-size:18px">Exness</div>
      </div>

      <div class="header-actions flex items-center" style="gap:12px">
        <button id="connect-portfolio-btn" class="btn-secondary">Connect Portfolio</button>
        <button id="start-free-trial" class="btn-primary">Start Free Trial</button>
        <button id="login-id-btn" class="btn-secondary">Login ID</button>
        <button id="more-options-btn" class="btn-secondary">More</button>
        <button id="get-app-btn" class="btn-primary">Get App</button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main id="main-content" style="padding-top:86px; padding-bottom:90px">
    <div class="container">

      <!-- Landing page (shown onload) -->
      <section id="landingPage" aria-labelledby="landingTitle">
        <div style="display:grid; grid-template-columns: 1fr; gap:18px;">

          <!-- Hero -->
          <div class="market-card" style="padding:22px; display:flex; flex-direction:column; gap:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h1 id="landingTitle" style="font-size:20px;font-weight:800">Auto-Trading Bot</h1>
                <p class="muted">Automated portfolio strategies and trade execution powered by Exness — optimized for performance and reliability.</p>
              </div>

              <div style="display:flex;gap:8px;align-items:center">
                <div class="muted" style="text-align:right">
                  <div style="font-size:14px">Market overview</div>
                  <div id="market-updated" style="font-size:12px">—</div>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
              <button id="hero-start-free-trial" class="btn-primary">Start Free Trial</button>
              <button id="hero-login" class="btn-secondary">Login ID</button>
              <button id="hero-connect-portfolio" class="btn-secondary">Connect Portfolio</button>
            </div>
          </div>

          <!-- Live prices + top coins -->
          <div class="market-card" style="display:grid; grid-template-columns: 1fr 320px; gap:12px;">
            <div style="padding:12px">
              <h3 style="font-weight:700;margin-bottom:8px">Live Prices</h3>
              <div id="price-list" style="display:flex;flex-direction:column;gap:10px"></div>
            </div>

            <div style="padding:12px;border-left:1px solid rgba(255,255,255,0.03)">
              <h3 style="font-weight:700;margin-bottom:8px">Top Coins</h3>
              <ul id="top-coins" style="display:flex;flex-direction:column;gap:8px;list-style:none;padding:0;margin:0"></ul>
            </div>
          </div>

          <!-- Charts (TradingView widgets per-click) -->
          <div class="market-card" style="padding:12px">
            <h3 style="font-weight:700;margin-bottom:8px">Charts</h3>
            <div class="muted" style="font-size:13px;margin-bottom:10px">Click a coin to open a live TradingView chart</div>
            <div id="chart-container" style="height:420px;background:transparent;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center">
              <div id="tv_chart_widget" style="width:100%;height:100%;"></div>
            </div>
          </div>

          <!-- Description / About -->
          <div class="market-card" style="padding:16px">
            <h3 style="font-weight:700;margin-bottom:8px">About the Exness Auto-Trading Bot</h3>
            <p class="muted" style="line-height:1.5">
              The Exness Auto-Trading Bot lets you connect your portfolio and use automated strategies to execute trades 24/7.
              This application demonstrates a Progressive Web App (PWA) with offline support, live price updates, and TradingView charts.
            </p>
            <p class="muted" style="margin-top:8px">
              Market data is via CoinGecko and charts are embedded via TradingView. The PWA can be installed to your home screen for quick access.
            </p>
          </div>

        </div>
      </section>

      <!-- Other pages (hidden by default) -->
      <section id="AI-Trading-Bot-page" style="display:none">
        <div class="market-card" style="padding:18px">
          <h2 style="font-weight:800">AI Trading Bot</h2>
          <p class="muted">This is the AI Trading Bot page (AI-Trading-Bot.html). When installed, this page will be cached by the service worker.</p>
        </div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div class="muted">© <span id="year"></span> Exness Auto-Trading Bot</div>
      <div class="muted">Privacy • Terms • Support</div>
    </div>
  </footer>

  <!-- Minimal inline script to handle UI, PWA install, manifest, SW, CoinGecko, TradingView and redirect flows -->
  <script>
  (function () {
    'use strict';

    // ---------- Configuration ----------
    const APP_NAME = 'Exness Auto-Trading Bot';
    const APP_SHORT = 'Exness';
    const THEME = '#0D1321';
    const ICON_PNG_URL = 'https://my.exness-static.com/cdn-cgi/image/width=300,height=300,format=auto/brand-assets/exness-logo.png';
    const CACHE_NAME = 'exness-bot-pwa-v1';
    const PRECACHE_URLS = ['/', '/index.html', '/AI-Trading-Bot.html'];
    const COINGECKO_MARKETS = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=8&page=1&sparkline=false&price_change_percentage=1h%2C24h%2C7d';

    // State
    let deferredPrompt = null;
    let swRegistration = null;
    let isAppInstalled = false;

    // Dom helpers
    const $ = id => document.getElementById(id);
    const q = sel => document.querySelector(sel);

    // Set year
    document.getElementById('year').innerText = new Date().getFullYear();

    // Landing control
    function showLanding() {
      // show landing, hide other pages
      $('landingPage').style.display = '';
      $('AI-Trading-Bot-page').style.display = 'none';
    }
    function showAIPage() {
      $('landingPage').style.display = 'none';
      $('AI-Trading-Bot-page').style.display = '';
    }
    window.goToLanding = showLanding;

    // Loading overlay show/hide (used for 15s redirect)
    function showLoadingOverlay(text='Preparing AI Trading Bot…') {
      const overlay = $('loading-overlay');
      if (!overlay) return;
      overlay.classList.add('active');
      $('loading-text').innerText = text;
    }
    function hideLoadingOverlay() {
      const overlay = $('loading-overlay');
      if (!overlay) return;
      overlay.classList.remove('active');
    }

    // ---------- Manifest (create blob) ----------
    function ensureManifest() {
      try {
        const existing = document.querySelector('link[rel="manifest"]');
        if (existing) existing.remove();
        const manifest = {
          name: APP_NAME,
          short_name: APP_SHORT,
          start_url: '/index.html',
          scope: '/',
          display: 'standalone',
          theme_color: THEME,
          background_color: THEME,
          description: 'Exness Auto-Trading Bot - Automated trading for a seamless experience.',
          icons: [
            { src: ICON_PNG_URL, sizes: '192x192', type: 'image/png', purpose: 'any' },
            { src: ICON_PNG_URL, sizes: '512x512', type: 'image/png', purpose: 'maskable any' }
          ],
          orientation: 'portrait'
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = url;
        document.head.appendChild(link);
        console.info('Manifest injected.');
      } catch (e) {
        console.error('Manifest injection failed', e);
      }
    }

    // ---------- Service Worker registration (try /sw.js then inline fallback) ----------
    async function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        console.warn('SW not supported');
        return null;
      }

      // Try to register a real /sw.js first (if available on server)
      try {
        const reg = await navigator.serviceWorker.register('/sw.js');
        swRegistration = reg;
        console.info('Service worker registered from /sw.js');
        return reg;
      } catch (err) {
        console.warn('No /sw.js or failed to register - falling back to inline SW.', err);
      }

      // Inline SW code (fallback)
      const swCode = `
        const CACHE_NAME='${CACHE_NAME}';
        const PRECACHE = ${JSON.stringify(PRECACHE_URLS)};
        self.addEventListener('install', evt => {
          evt.waitUntil((async () => {
            const c = await caches.open(CACHE_NAME);
            try { await c.addAll(PRECACHE); } catch(e) { /* ignore individual failures */ }
            self.skipWaiting();
          })());
        });
        self.addEventListener('activate', evt => {
          evt.waitUntil((async () => {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => k===CACHE_NAME? Promise.resolve(): caches.delete(k)));
            await self.clients.claim();
          })());
        });
        self.addEventListener('fetch', evt => {
          evt.respondWith((async () => {
            try {
              const cache = await caches.open(CACHE_NAME);
              const cached = await cache.match(evt.request);
              if (cached) return cached;
              const response = await fetch(evt.request);
              if (evt.request.method === 'GET' && response && response.status===200 && evt.request.url.startsWith(self.location.origin)) {
                cache.put(evt.request, response.clone()).catch(()=>{});
              }
              return response;
            } catch(e) {
              if (evt.request.mode === 'navigate') {
                const cache = await caches.open(CACHE_NAME);
                const fallback = await cache.match('/index.html') || cache.match('/');
                if (fallback) return fallback;
              }
              return new Response('Offline', { status:503, statusText:'Offline' });
            }
          })());
        });
        self.addEventListener('message', async (evt) => {
          const data = evt.data || {};
          if (data && data.type === 'CACHE_URLS' && Array.isArray(data.urls)) {
            try {
              const cache = await caches.open(CACHE_NAME);
              await cache.addAll(data.urls);
              const cs = await self.clients.matchAll();
              cs.forEach(c => c.postMessage({ type:'cached', urls:data.urls }));
            } catch(err) {
              const cs = await self.clients.matchAll();
              cs.forEach(c => c.postMessage({ type:'cache_failed', error: String(err) }));
            }
          }
        });
      `;
      try {
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const reg = await navigator.serviceWorker.register(url);
        swRegistration = reg;
        console.info('Inline SW registered');
        return reg;
      } catch (err) {
        console.error('Inline SW registration failed', err);
        return null;
      }
    }

    // ---------- Cache helper ----------
    async function cacheResources(urls = PRECACHE_URLS) {
      if (!('caches' in window)) return false;
      try {
        const cache = await caches.open(CACHE_NAME);
        const unique = Array.from(new Set((urls || []).filter(u => typeof u === 'string')));
        await cache.addAll(unique);
        return true;
      } catch (e) {
        console.warn('cacheResources error', e);
        return false;
      }
    }

    // ---------- Install Modal UI ----------
    function ensureInstallModalExists() {
      // already in HTML so no-op here
    }
    function showInstallModal() {
      $('pwa-install-modal').style.display = 'flex';
      const prog = $('pwa-install-progress'); if (prog) prog.style.display = 'none';
      const bar = $('pwa-install-progress-bar'); if (bar) bar.style.width = '0%';
      const text = $('pwa-install-progress-text'); if (text) text.innerText = 'Ready to install';
      const btn = $('install-now-btn'); if (btn) { btn.disabled = false; btn.innerText = (deferredPrompt ? 'Install Now' : 'Get App'); btn.style.opacity = '1'; }
    }
    function hideInstallModal() { $('pwa-install-modal').style.display = 'none'; }

    async function onInstallNowClicked(e) {
      e && e.preventDefault && e.preventDefault();
      const installBtn = $('install-now-btn');
      const cancelBtn = $('cancel-install-btn');
      const progress = $('pwa-install-progress');
      const progressBar = $('pwa-install-progress-bar');
      const progressText = $('pwa-install-progress-text');
      if (installBtn) { installBtn.disabled = true; installBtn.style.opacity = '0.7'; installBtn.innerText = 'Starting...'; }
      if (cancelBtn) cancelBtn.disabled = true;
      if (progress) progress.style.display = 'block';

      // If native prompt available
      if (deferredPrompt) {
        try {
          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          deferredPrompt = null;
          if (choice.outcome === 'accepted') {
            if (progressBar) progressBar.style.width = '60%';
            if (progressText) progressText.innerText = 'Finalizing native install...';
            // Wait for appinstalled event or register fallback caching
            await waitForAppInstalledOrTimeout(12000);
            await ensureSWAndCacheWithProgress(progressBar, progressText);
            finalizeInstallUI(true);
            return;
          } else {
            if (progressBar) progressBar.style.width = '25%';
            if (progressText) progressText.innerText = 'Native prompt dismissed — fallback install...';
            await fallbackInstallSequence(progressBar, progressText);
            finalizeInstallUI(true, 'installed (fallback)');
            return;
          }
        } catch (err) {
          console.warn('deferredPrompt.prompt error', err);
        }
      }

      // fallback if no deferredPrompt
      if (progressText) progressText.innerText = 'Registering service worker...';
      await fallbackInstallSequence(progressBar, progressText);
      finalizeInstallUI(true, 'installed (fallback)');
    }

    function finalizeInstallUI(success=true, extra='') {
      const installBtn = $('install-now-btn');
      const cancelBtn = $('cancel-install-btn');
      const progressText = $('pwa-install-progress-text');
      if (installBtn) {
        installBtn.innerText = success ? 'App installed' : 'Install';
        installBtn.disabled = true;
        if (success) installBtn.style.background = '#16A34A';
      }
      if (cancelBtn) cancelBtn.disabled = false;
      if (progressText) progressText.innerText = success ? `App installed${extra? ' — ' + extra : ''}` : 'Installation failed';
      isAppInstalled = !!success;
      setTimeout(hideInstallModal, 1400);
      // show toast
      const t = document.createElement('div');
      t.innerText = success ? APP_NAME + ' installed' : 'Installation failed';
      t.style.position = 'fixed'; t.style.right = '16px'; t.style.bottom = '16px'; t.style.background='#111827';
      t.style.color = '#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex='10000';
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),3500);
    }

    // fallback install sequence
    async function fallbackInstallSequence(progressBar, progressText) {
      try {
        if (progressText) progressText.innerText = 'Registering service worker...';
        const reg = await registerServiceWorker();
        if (reg && reg.active) {
          if (progressBar) progressBar.style.width = '35%';
          if (progressText) progressText.innerText = 'Preparing app files...';
          try { reg.active.postMessage({ type:'CACHE_URLS', urls: PRECACHE_URLS }); } catch(e){}
          await cacheResources(PRECACHE_URLS);
          if (progressBar) progressBar.style.width = '95%';
          if (progressText) progressText.innerText = 'Finalizing...';
          await new Promise(r=>setTimeout(r,700));
          maybeShowIOSInstructions();
        } else {
          if (progressBar) progressBar.style.width = '45%';
          if (progressText) progressText.innerText = 'Caching app resources...';
          await cacheResources(PRECACHE_URLS);
          if (progressBar) progressBar.style.width = '95%';
          if (progressText) progressText.innerText = 'Finalizing...';
          await new Promise(r=>setTimeout(r,700));
          maybeShowIOSInstructions();
        }
      } catch(e) {
        console.error('fallbackInstallSequence error', e);
        if (progressText) progressText.innerText = 'Installation encountered issues — offline may be limited.';
      }
    }

    function maybeShowIOSInstructions() {
      const ua = navigator.userAgent || '';
      if (/iphone|ipad|ipod/i.test(ua) && !window.matchMedia('(display-mode: standalone)').matches) {
        const t = $('pwa-install-progress-text');
        if (t) t.innerText = 'Tap Share → Add to Home Screen to install on iOS';
      }
    }

    async function ensureSWAndCacheWithProgress(progressBar, progressText) {
      try {
        if (progressText) progressText.innerText = 'Ensuring service worker...';
        const reg = swRegistration || await registerServiceWorker();
        if (reg && reg.active) {
          if (progressBar) progressBar.style.width = '50%';
          progressText && (progressText.innerText = 'Caching app files...');
          try { reg.active.postMessage({ type:'CACHE_URLS', urls: PRECACHE_URLS }); } catch(e){}
          await cacheResources(PRECACHE_URLS);
          if (progressBar) progressBar.style.width = '100%';
          progressText && (progressText.innerText = 'App files cached');
          return true;
        } else {
          await cacheResources(PRECACHE_URLS);
          if (progressBar) progressBar.style.width = '100%';
          if (progressText) progressText.innerText = 'App files cached (no service worker active)';
          return true;
        }
      } catch(e) {
        console.warn('ensureSWAndCacheWithProgress error', e);
        return false;
      }
    }

    function waitForAppInstalledOrTimeout(timeoutMs=15000) {
      return new Promise((resolve) => {
        if (isAppInstalled) return resolve();
        let done=false;
        function onInstalled() {
          if (done) return;
          done=true;
          window.removeEventListener('appinstalled', onInstalled);
          resolve();
        }
        window.addEventListener('appinstalled', onInstalled);
        setTimeout(()=>{ if(done) return; done=true; window.removeEventListener('appinstalled', onInstalled); resolve(); }, timeoutMs);
      });
    }

    // ---------- Setup SW message handler ----------
    function setupSWMessageHandler() {
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker.addEventListener('message', (evt) => {
        const data = evt.data || {};
        const progressBar = $('pwa-install-progress-bar');
        const progressText = $('pwa-install-progress-text');
        if (!data || !data.type) return;
        if (data.type === 'cached' || data.type === 'precached') {
          if (progressBar) progressBar.style.width = '100%';
          if (progressText) progressText.innerText = 'App files cached';
          setTimeout(()=>finalizeInstallUI(true),700);
        } else if (data.type === 'cache_failed') {
          if (progressText) progressText.innerText = 'Caching failed — offline may be limited';
          finalizeInstallUI(true, 'partial');
        }
      });
    }

    // ---------- Hook Get App / Install buttons ----------
    function setupGetAppButtons() {
      const ids = ['get-app-btn','getApp','get-mobile-app','getAppButton','get-app'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', (e)=> { e.preventDefault(); showInstallModal(); });
      });
      // main header button
      const headerBtn = $('get-app-btn') || $('get-app-btn') || $('getApp');
      if ($('get-app-btn')) $('get-app-btn').addEventListener('click', (e)=> { e.preventDefault(); showInstallModal(); });
      if ($('get-app-btn') === null) { /* no-op */ }

      // fallback global open store
      window.openStoreOrPrompt = function() {
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes('android')) window.open('https://play.google.com/store/apps', '_blank');
        else if (/(iphone|ipad|ipod)/i.test(navigator.userAgent)) window.open('https://apps.apple.com/', '_blank');
        else showInstallModal();
      };
    }

    // ---------- Hook more options dropdown ----------
    function attachMoreOptions() {
      const more = $('more-options-btn');
      if (!more) return;
      more.addEventListener('click', (e) => {
        e.preventDefault();
        // simple dropdown using window.prompt (keeps everything in single file)
        const choice = window.prompt('More options:\\n1) Connect Portfolio\\n2) Login ID\\n3) Support\\n4) Connect Wallet\\n5) Start Free Trial\\nEnter number to choose');
        if (!choice) return;
        switch(choice.trim()) {
          case '1': triggerActionConnectPortfolio(); break;
          case '2': triggerActionLogin(); break;
          case '3': window.open('mailto:support@exness.com'); break;
          case '4': alert('Connect wallet flow (placeholder)'); break;
          case '5': triggerActionStartFreeTrial(); break;
          default: break;
        }
      });
    }

    // ---------- Attach auth / redirect buttons ----------
    function attachRedirectButtons() {
      const startButtons = ['start-free-trial','hero-start-free-trial'];
      startButtons.forEach(id => {
        if ($(id)) $(id).addEventListener('click', (e)=> { e.preventDefault(); triggerActionStartFreeTrial(); });
      });
      const connectButtons = ['connect-portfolio-btn','hero-connect-portfolio'];
      connectButtons.forEach(id => { if ($(id)) $(id).addEventListener('click', (e)=>{ e.preventDefault(); triggerActionConnectPortfolio(); }); });
      const loginButtons = ['login-id-btn','hero-login'];
      loginButtons.forEach(id => { if ($(id)) $(id).addEventListener('click', (e)=>{ e.preventDefault(); triggerActionLogin(); }); });
      // header get app
      if ($('get-app-btn')) $('get-app-btn').addEventListener('click', (e)=> { e.preventDefault(); showInstallModal(); });
      // install modal actions
      if ($('install-now-btn')) $('install-now-btn').addEventListener('click', onInstallNowClicked);
      if ($('cancel-install-btn')) $('cancel-install-btn').addEventListener('click', hideInstallModal);
    }

    // Simulated 15s load then redirect to AI-Trading-Bot.html
    function triggerActionStartFreeTrial() { trigger15sRedirect('/AI-Trading-Bot.html', 'Starting free trial...'); }
    function triggerActionConnectPortfolio() { trigger15sRedirect('/AI-Trading-Bot.html', 'Connecting portfolio...'); }
    function triggerActionLogin() { trigger15sRedirect('/AI-Trading-Bot.html', 'Logging in...'); }

    function trigger15sRedirect(url, loadingText) {
      showLoadingOverlay(loadingText || 'Loading...');
      // Start caching AI-Trading-Bot.html while waiting
      try {
        if (swRegistration && swRegistration.active) {
          swRegistration.active.postMessage({ type:'CACHE_URLS', urls: [url] });
        } else if ('caches' in window) {
          caches.open(CACHE_NAME).then(c => c.add(url).catch(()=>{}));
        }
      } catch(e){ /* ignore */ }

      // Wait 15 seconds then navigate
      setTimeout(() => {
        hideLoadingOverlay();
        // Prefer to navigate to local AI-Trading-Bot.html or show local page
        // If the file exists server-side, this will navigate. Otherwise show internal page.
        if (location.origin) {
          // attempt to navigate normally
          location.href = url;
        } else {
          // fallback to internal page
          showAIPage();
        }
      }, 15000);
    }

    // ---------- Fetch market data from CoinGecko ----------
    async function fetchMarketData() {
      try {
        const res = await fetch(COINGECKO_MARKETS);
        if (!res.ok) throw new Error('Market fetch failed');
        const data = await res.json();
        renderPrices(data);
      } catch (e) {
        console.warn('fetchMarketData error', e);
      }
    }

    function renderPrices(data) {
      if (!Array.isArray(data)) return;
      const priceList = $('price-list');
      const topCoins = $('top-coins');
      priceList.innerHTML = '';
      topCoins.innerHTML = '';
      // choose first 8
      data.slice(0,8).forEach((c, idx) => {
        // price row
        const row = document.createElement('div');
        row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
        row.style.padding = '8px 0'; row.style.borderBottom = '1px dashed rgba(255,255,255,0.03)';
        row.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <img src="${c.image}" style="width:28px;height:28px;border-radius:6px;object-fit:cover" alt="${c.symbol}" />
            <div>
              <div style="font-weight:700">${c.name} <span class="muted" style="font-weight:500">${c.symbol.toUpperCase()}</span></div>
              <div class="muted" style="font-size:12px">MC ${formatNumber(c.market_cap)}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">$${formatNumber(c.current_price)}</div>
            <div style="font-size:12px;color:${c.price_change_percentage_24h>=0?'#16C784':'#EA3943'}">${(c.price_change_percentage_24h||0).toFixed(2)}%</div>
          </div>
        `;
        row.addEventListener('click', ()=> loadTradingViewForSymbol(c.symbol.toUpperCase() + 'USD'));
        priceList.appendChild(row);

        // top coin list
        const li = document.createElement('li');
        li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center';
        li.style.padding='8px 0';
        li.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><img src="${c.image}" style="width:20px;height:20px;border-radius:6px" /><div style="font-weight:600">${c.symbol.toUpperCase()}</div></div><div class="muted">$${formatNumber(c.current_price)}</div>`;
        li.addEventListener('click', ()=> loadTradingViewForSymbol(c.symbol.toUpperCase() + 'USD'));
        topCoins.appendChild(li);
      });
      // update market time
      $('market-updated').innerText = 'Updated: ' + new Date().toLocaleTimeString();
    }

    function formatNumber(n) {
      try { return Number(n).toLocaleString(undefined, {maximumFractionDigits:2}); } catch(e){ return n; }
    }

    // ---------- TradingView chart loader ----------
    function loadTradingViewForSymbol(symbol) {
      // Clear old widget if exists
      const container = document.getElementById('tv_chart_widget');
      container.innerHTML = '';
      // Create widget with TradingView
      try {
        if (typeof TradingView !== 'undefined') {
          new TradingView.widget({
            container_id: 'tv_chart_widget',
            width: '100%',
            height: '100%',
            symbol: symbol,
            interval: 'D',
            timezone: 'Etc/UTC',
            theme: 'dark',
            style: '1',
            locale: 'en',
            toolbar_bg: '#1A2744',
            enable_publishing: false,
            allow_symbol_change: true,
            hideideas: true
          });
        } else {
          container.innerHTML = '<div class="muted">TradingView not available</div>';
        }
      } catch(e) {
        console.warn('TradingView load error', e);
        container.innerHTML = '<div class="muted">Chart load failed</div>';
      }
    }

    // ---------- Init on DOM ready ----------
    async function init() {
      ensureManifest();
      setupGetAppButtons();
      attachRedirectButtons();
      attachMoreOptions();
      setupSWMessageHandler();
      setupGetAppButtons();

      // Register Service worker asynchronously
      try {
        registerServiceWorker().then(reg => {
          if (reg) { swRegistration = reg; setupSWMessageHandler(); }
        }).catch(e => console.warn('sw register err', e));
      } catch(e){}

      // Show install prompt automatically onload
      window.addEventListener('load', () => {
        // small delay to make sure UI settled
        setTimeout(() => {
          try { showInstallModal(); } catch(e){}
        }, 800);
      });

      // Capture beforeinstallprompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.info('beforeinstallprompt captured');
        // show the modal indicating install available
        try { showInstallModal(); } catch(e){}
      });

      // appinstalled event
      window.addEventListener('appinstalled', (evt) => {
        console.info('PWA installed', evt);
        isAppInstalled = true;
        finalizeInstallUI(true);
      });

      // initial market load
      fetchMarketData();
      setInterval(fetchMarketData, 30000);

      // default chart load (BTC)
      loadTradingViewForSymbol('BTCUSD');
    }

    // convenience
    function setupGetAppButtons() {
      const headerBtn = $('get-app-btn');
      if (headerBtn) headerBtn.addEventListener('click', (e)=> { e.preventDefault(); showInstallModal(); });
      // also wire the main header "Get App" visible button
      const getAppMain = $('get-app-btn');
      if (getAppMain) getAppMain.addEventListener('click', (e)=> { e.preventDefault(); showInstallModal(); });
    }

    // expose some functions to window for debugging
    window.pwaInstaller = { showInstallModal, hideInstallModal, ensureManifest, registerServiceWorker, cacheResources, isAppInstalled: () => isAppInstalled };

    // init
    init();

  })();
  </script>

</body>
</html>
