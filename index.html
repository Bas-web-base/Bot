<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exness Auto-Trading Bot</title>
    
    <!-- Theme Color and PWA Meta -->
    <meta name="theme-color" content="#0D1321">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="pwa-manifest-link">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Base Dark Mode Theme (Exness inspired colors) */
        :root {
            --primary-bg: #0D1321; /* Dark background */
            --secondary-bg: #12213A; /* Card/section background */
            --primary-text: #E5E7EB; /* Light text */
            --accent-color: #00A389; /* Green accent (like Exness brand color) */
            --hover-color: #00C4A4;
            --border-color: #1E3557;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            min-height: 100vh;
        }
        
        /* Custom scrollbar for better look in dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--primary-bg); }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--hover-color); }

        /* Custom utility classes */
        .btn-primary {
            background-color: var(--accent-color);
            color: #fff;
            padding: 10px 24px;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 163, 137, 0.4);
        }
        .btn-primary:hover {
            background-color: var(--hover-color);
            box-shadow: 0 6px 20px rgba(0, 196, 164, 0.6);
        }
        .btn-secondary {
            background-color: transparent;
            color: var(--primary-text);
            padding: 10px 24px;
            border-radius: 9999px;
            border: 2px solid var(--border-color);
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .card {
            background-color: var(--secondary-bg);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* PWA Install Prompt Styling */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90%;
            width: 400px;
            padding: 20px;
            background-color: var(--secondary-bg);
            border-radius: 1rem;
            border: 2px solid var(--accent-color);
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Loading Overlay for Redirection */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 19, 33, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-white">Redirecting to Trading Bot...</p>
        <p class="mt-2 text-sm text-gray-400">Please wait 15 seconds.</p>
    </div>

    <!-- Main Content Container -->
    <div id="landing-page" class="min-h-screen">
        
        <!-- Header / Navigation Bar -->
        <header class="sticky top-0 z-50 bg-[--primary-bg] bg-opacity-95 backdrop-blur-md border-b border-[--border-color] shadow-lg">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <!-- Exness-style Logo Placeholder (Inline SVG for simplicity) -->
                    <svg class="h-6 w-6 text-[--accent-color]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    </svg>
                    <span class="text-xl font-bold text-white">Exness Bot</span>
                </div>

                <!-- Desktop/Primary Actions -->
                <div class="hidden md:flex space-x-4 items-center">
                    <button id="connect-portfolio-btn-desktop" class="text-sm font-medium hover:text-[--accent-color] transition">Connect Portfolio</button>
                    <button id="login-id-btn-desktop" class="btn-secondary text-sm">Login ID</button>
                    <button id="start-free-trial-btn-desktop" class="btn-primary text-sm">Start Free Trial</button>
                    <button id="install-app-btn-desktop" class="btn-primary text-sm bg-blue-600 hover:bg-blue-700 ml-4 hidden">Get Mobile App</button>
                </div>

                <!-- Mobile Menu and More Options Toggle -->
                <div class="flex md:hidden items-center space-x-3">
                    <button id="install-app-btn-mobile" class="btn-primary text-xs py-2 px-3 bg-blue-600 hover:bg-blue-700 hidden">Get App</button>
                    <button id="more-options-toggle" class="p-2 rounded-full hover:bg-[--border-color] transition">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </nav>
        </header>
        
        <!-- More Options Dropdown (Hidden by default) -->
        <div id="more-options-panel" class="absolute right-4 md:hidden z-40 mt-1 w-64 card p-4 shadow-xl hidden">
            <button id="connect-portfolio-btn-mobile" class="w-full text-left py-2 px-3 hover:bg-[--border-color] rounded-lg transition">Connect Portfolio</button>
            <button id="login-id-btn-mobile" class="w-full text-left py-2 px-3 hover:bg-[--border-color] rounded-lg transition">Login ID</button>
            <button id="support-btn-mobile" class="w-full text-left py-2 px-3 hover:bg-[--border-color] rounded-lg transition">Support</button>
            <button id="connect-wallet-btn-mobile" class="w-full text-left py-2 px-3 hover:bg-[--border-color] rounded-lg transition">Connect Wallet</button>
            <div class="mt-3 pt-3 border-t border-[--border-color]">
                <button id="start-free-trial-btn-mobile" class="btn-primary w-full text-sm">Start Free Trial</button>
            </div>
        </div>

        <!-- Hero Section / Landing Page Content -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-20">
            <section class="text-center max-w-4xl mx-auto mb-16">
                <h1 class="text-4xl sm:text-6xl font-extrabold leading-tight mb-4 text-transparent bg-clip-text bg-gradient-to-r from-white to-[--accent-color]">
                    Auto-Trading Bot
                </h1>
                <p class="text-xl sm:text-2xl font-light text-gray-300 mb-8">
                    Trade like a professional with AI-powered algorithms. Connect your portfolio and start your free trial today.
                </p>
                <div class="flex justify-center space-x-4 flex-wrap gap-4">
                    <button id="hero-connect-portfolio-btn" class="btn-secondary">
                        Connect Portfolio
                    </button>
                    <button id="hero-start-free-trial-btn" class="btn-primary">
                        Start Free Trial
                    </button>
                </div>
            </section>
            
            <!-- TradingView Chart & Market Overview -->
            <section class="grid lg:grid-cols-3 gap-6">
                <!-- Live Chart Panel (2/3 width on desktop) -->
                <div class="lg:col-span-2 card p-4 h-[400px] md:h-[550px] flex flex-col">
                    <h2 class="text-xl font-semibold mb-3">Live Price Performance Chart</h2>
                    <!-- TradingView Widget Container -->
                    <div id="tradingview-chart-container" class="flex-grow w-full rounded-lg overflow-hidden border border-[--border-color]">
                        <!-- TradingView chart will be injected here -->
                        <div id="tradingview-chart" class="w-full h-full"></div>
                    </div>
                </div>

                <!-- Top Coins List (Market Overview) (1/3 width on desktop) -->
                <div class="lg:col-span-1 card p-4 overflow-hidden flex flex-col">
                    <h2 class="text-xl font-semibold mb-4">Market Overview & Top Coins</h2>
                    <div id="top-coins-list" class="space-y-3 overflow-y-auto pr-2 flex-grow">
                        <!-- Coin items will be dynamically loaded here -->
                        <p class="text-gray-500">Loading market data...</p>
                    </div>
                </div>
            </section>

            <!-- Description Section -->
            <section class="mt-16 pt-10 border-t border-[--border-color]">
                <h2 class="text-3xl font-bold mb-6 text-center">Disruption in Trading Technology</h2>
                <div class="max-w-4xl mx-auto space-y-6 text-lg text-gray-300">
                    <p>Exness Auto-Trading Bot is revolutionizing the financial markets by providing unparalleled speed, precision, and efficiency. We leverage cutting-edge machine learning and predictive analytics to execute trades with optimal timing, ensuring you capitalize on market movements that human traders often miss.</p>
                    <p>Our proprietary AI engine constantly monitors global market signals, economic indicators, and liquidity pools across major exchanges. This sophisticated grounding allows the bot to adapt its strategy in real-time, delivering consistent performance even in volatile market conditions. Stop trading manually—start trading intelligently.</p>
                    <p>Experience the next generation of financial autonomy. Our platform integrates seamlessly with major portfolio providers and wallets, offering enterprise-grade security and transparency. The bot is designed for both novices seeking passive income and seasoned traders looking for a technological edge. Join the future of trading now.</p>
                </div>
            </section>

            <!-- PWA Install Prompt (Custom UI) -->
            <div id="pwa-install-prompt-ui" class="install-prompt hidden">
                <h3 class="text-2xl font-bold mb-2 text-[--accent-color]">Install App</h3>
                <p class="text-gray-300 mb-4">Install the Exness Auto-Trading Bot for the best mobile experience and offline access!</p>
                <div class="flex justify-center gap-3">
                    <button id="install-now-button" class="btn-primary text-sm px-6">Install Now</button>
                    <button id="maybe-later-button" class="btn-secondary text-sm px-6">Maybe Later</button>
                </div>
            </div>

        </main>

        <!-- Global Footer -->
        <footer class="bg-[--secondary-bg] border-t border-[--border-color] mt-16 py-8">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-400">
                <div class="flex justify-center space-x-6 mb-4">
                    <a href="#" class="hover:text-[--accent-color] transition">Privacy Policy</a>
                    <a href="#" class="hover:text-[--accent-color] transition">Terms of Service</a>
                    <a href="#" class="hover:text-[--accent-color] transition">Support</a>
                </div>
                <p>&copy;Exness Auto-Trading Bot. All rights reserved.</p>
            </div>
        </footer>

       </div>

    <script>
(function () {
  'use strict';

  /* =========================
     Config / Assets
     ========================= */
  const APP_NAME = 'Exness Auto-Trading Bot';
  const APP_SHORT_NAME = 'Exness Bot';
  const THEME_COLOR = '#1E2329';
  const BACKGROUND_COLOR = '#1E2329';
  const START_URL = './Binancereal-index.html';
  const SCOPE = './';
  const CACHE_NAME = 'exness-auto-trading-pwa-v1';
  const PRECACHE_URLS = [
    './Binancereal-index.html',
    './AI-Trading-Bot.html'
  ];

  // NOTE: To embed the exact uploaded Exness PNG, replace ICON_BASE64 with the real base64 data for that PNG.
  // The value below is a placeholder data URL — replace if you want the exact uploaded image embedded in the manifest.
  const ICON_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABGElEQVR4Xu3XMQ0AAAjDMO5fN5h3gQGgK9g7wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4G1j2AAE0vQpRAAAAABJRU5ErkJggg==';

  /* =========================
     State
     ========================= */
  let deferredPrompt = null;
  let swRegistration = null;
  let manifestBlobUrl = null;
  let isAppInstalled = false;

  /* =========================
     Small DOM helpers
     ========================= */
  function $ (id) { return document.getElementById(id); }
  function createEl (tag, props = {}, children = []) {
    const el = document.createElement(tag);
    Object.keys(props).forEach(k => {
      if (k === 'style') Object.assign(el.style, props[k]);
      else if (k === 'attrs') Object.keys(props.attrs).forEach(a => el.setAttribute(a, props.attrs[a]));
      else el[k] = props[k];
    });
    (Array.isArray(children) ? children : [children]).forEach(c => {
      if (typeof c === 'string') el.appendChild(document.createTextNode(c));
      else if (c) el.appendChild(c);
    });
    return el;
  }

  /* =========================
     Loading overlay (reusable)
     ========================= */
  function ensureLoadingOverlay() {
    let overlay = $('pwa-loading-overlay');
    if (overlay) return overlay;
    overlay = createEl('div', { id: 'pwa-loading-overlay', style: {
      position: 'fixed', inset: '0', display: 'none',
      alignItems: 'center', justifyContent: 'center',
      background: 'rgba(0,0,0,0.7)', zIndex: 2147483647, color: '#fff', fontFamily: 'Inter, system-ui, -apple-system, "Segoe UI", Roboto'
    }});
    const inner = createEl('div', { style: { textAlign: 'center', maxWidth: '92%', padding: '18px', color: '#fff' }});
    inner.innerHTML = `<div id="pwa-spinner" style="margin:auto;border:6px solid rgba(255,255,255,0.12);border-top:6px solid #FCD535;border-radius:50%;width:56px;height:56px;animation: pwa-spin 1s linear infinite"></div><div id="pwa-loading-message" style="margin-top:12px;font-size:16px">Loading...</div><style>@keyframes pwa-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>`;
    overlay.appendChild(inner);
    document.body.appendChild(overlay);
    return overlay;
  }
  function showLoading(message = 'Loading...') {
    const overlay = ensureLoadingOverlay();
    overlay.querySelector('#pwa-loading-message').textContent = message;
    overlay.style.display = 'flex';
  }
  function hideLoading() {
    const overlay = $('pwa-loading-overlay');
    if (overlay) overlay.style.display = 'none';
  }

  /* =========================
     Manifest creation (blob)
     ========================= */
  function ensureManifest() {
    try {
      // Remove prior manifest
      const existing = document.querySelector('link[rel="manifest"]');
      if (existing) existing.parentNode.removeChild(existing);

      const manifest = {
        name: APP_NAME,
        short_name: APP_SHORT_NAME,
        start_url: START_URL,
        scope: SCOPE,
        display: 'standalone',
        orientation: 'portrait',
        theme_color: THEME_COLOR,
        background_color: BACKGROUND_COLOR,
        icons: [
          { src: ICON_BASE64, sizes: '192x192', type: 'image/png' },
          { src: ICON_BASE64, sizes: '512x512', type: 'image/png', purpose: 'maskable any' }
        ],
        description: 'Exness Auto-Trading Bot — AI trading companion & wallet'
      };

      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      manifestBlobUrl = URL.createObjectURL(blob);
      const link = createEl('link', { attrs: { rel: 'manifest', href: manifestBlobUrl }});
      link.id = 'pwa-manifest-link';
      document.head.appendChild(link);
      console.info('PWA manifest created and injected.');
    } catch (err) {
      console.error('ensureManifest error:', err);
    }
  }

  /* =========================
     Service Worker registration (tries /sw.js then inline blob fallback)
     ========================= */
  const swBlobContent = `
    const CACHE_NAME = '${CACHE_NAME}';
    const PRECACHE = ${JSON.stringify(PRECACHE_URLS)};
    self.addEventListener('install', event => {
      event.waitUntil((async () => {
        const c = await caches.open(CACHE_NAME);
        try { await c.addAll(PRECACHE); } catch (e) { console.warn('SW precache issue', e); }
        self.skipWaiting();
      })());
    });
    self.addEventListener('activate', event => {
      event.waitUntil((async () => {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => k === CACHE_NAME ? Promise.resolve() : caches.delete(k)));
        await self.clients.claim();
      })());
    });
    self.addEventListener('fetch', event => {
      event.respondWith((async () => {
        try {
          const cached = await caches.match(event.request);
          if (cached) return cached;
          const response = await fetch(event.request);
          // Optionally cache same-origin GET successful responses
          if (event.request.method === 'GET' && response && response.status === 200 && event.request.url.startsWith(self.location.origin)) {
            try {
              const cache = await caches.open(CACHE_NAME);
              cache.put(event.request, response.clone()).catch(()=>{});
            } catch(e){}
          }
          return response;
        } catch (err) {
          // If navigation request, return cached start page
          if (event.request.mode === 'navigate') {
            const c = await caches.open(CACHE_NAME);
            const fallback = await c.match('${START_URL}') || await c.match('/index.html') || await c.match('/Binancereal-index.html') || null;
            if (fallback) return fallback;
          }
          return new Response('Offline', { status: 503, statusText: 'Offline' });
        }
      })());
    });
    // Support messages from page to pre-cache further URLs
    self.addEventListener('message', async (evt) => {
      const data = evt.data || {};
      if (data && data.type === 'CACHE_URLS' && Array.isArray(data.urls)) {
        try {
          const c = await caches.open(CACHE_NAME);
          await c.addAll(data.urls);
          const clients = await self.clients.matchAll();
          clients.forEach(cl => cl.postMessage({ type: 'cached', urls: data.urls }));
        } catch (e) {
          const clients = await self.clients.matchAll();
          clients.forEach(cl => cl.postMessage({ type: 'cache_failed', error: String(e) }));
        }
      }
    });
  `;

  async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
      console.warn('ServiceWorker not supported.');
      return null;
    }
    try {
      // Try server-provided /sw.js first
      try {
        const reg = await navigator.serviceWorker.register('/sw.js');
        swRegistration = reg;
        console.info('Service Worker registered from /sw.js');
        return reg;
      } catch (err) {
        console.info('/sw.js not registered; falling back to inline blob SW.');
      }
      // Fallback: inline blob SW
      const blob = new Blob([swBlobContent], { type: 'application/javascript' });
      const blobUrl = URL.createObjectURL(blob);
      const reg = await navigator.serviceWorker.register(blobUrl);
      swRegistration = reg;
      console.info('Inline Service Worker registered.');
      return reg;
    } catch (err) {
      console.error('registerServiceWorker error:', err);
      return null;
    }
  }

  /* =========================
     Install modal UI (custom) - created once and used for all prompts
     ========================= */
  function ensureInstallModalExists() {
    if ($('exness-pwa-install-modal')) return;

    const overlay = createEl('div', {
      id: 'exness-pwa-install-modal',
      style: {
        position: 'fixed', inset: '0', display: 'none',
        alignItems: 'center', justifyContent: 'center', background: 'rgba(0,0,0,0.45)',
        zIndex: 2147483647, fontFamily: 'Inter, system-ui, -apple-system, "Segoe UI", Roboto'
      }
    });

    const card = createEl('div', { style: {
      width: '420px', maxWidth: '94%', background: '#1E2329', borderRadius: '14px', padding: '18px',
      boxShadow: '0 10px 30px rgba(0,0,0,0.5)', color: '#EAECEF', border: '1px solid #2B3139'
    }});

    const header = createEl('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '10px' }});
    const logo = createEl('img', { attrs: { id: 'exness-pwa-logo', src: ICON_BASE64, alt: 'App Logo' }, style: { width: '54px', height: '54px', borderRadius: '10px', objectFit: 'cover', border: '1px solid rgba(255,255,255,0.06)' }});
    const title = createEl('div', { innerText: `Install ${APP_NAME}`, style: { fontSize: '18px', fontWeight: 700, color: '#FCD535' }});
    header.appendChild(logo); header.appendChild(title);

    const desc = createEl('div', { innerText: 'Install the full app for fast access, offline support, and access to the AI Trading Bot. The app will be cached and added to your device.', style: { fontSize: '13px', color: '#9AA4B2' }});

    const progress = createEl('div', { id: 'exness-pwa-progress', style: { display: 'none', marginTop: '12px' }});
    const progressOuter = createEl('div', { style: { width: '100%', height: '10px', background: '#242933', borderRadius: '8px', overflow: 'hidden', border: '1px solid #2B3139' }});
    const progressBar = createEl('div', { id: 'exness-pwa-progress-bar', style: { width: '0%', height: '100%', background: '#FCD535', transition: 'width 300ms ease' }});
    progressOuter.appendChild(progressBar);
    const progressText = createEl('div', { id: 'exness-pwa-progress-text', innerText: 'Ready to install', style: { fontSize: '13px', marginTop: '8px', color: '#9AA4B2' }});
    progress.appendChild(progressOuter); progress.appendChild(progressText);

    const actions = createEl('div', { style: { display: 'flex', gap: '10px', justifyContent: 'flex-end', marginTop: '14px' }});
    const cancelBtn = createEl('button', { innerText: 'Cancel', attrs: { id: 'exness-pwa-cancel' }, style: { padding: '8px 12px', borderRadius: '10px', border: '1px solid #2B3139', background: '#242933', color: '#EAECEF', cursor: 'pointer', fontWeight: 600 }});
    const installBtn = createEl('button', { innerText: 'Install App', attrs: { id: 'exness-pwa-install-now' }, style: { padding: '8px 14px', borderRadius: '10px', border: '0', background: '#FCD535', color: '#111', cursor: 'pointer', fontWeight: 800 }});
    actions.appendChild(cancelBtn); actions.appendChild(installBtn);

    card.appendChild(header); card.appendChild(desc); card.appendChild(progress); card.appendChild(actions);
    overlay.appendChild(card); document.body.appendChild(overlay);

    cancelBtn.addEventListener('click', () => overlay.style.display = 'none');
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });

    installBtn.addEventListener('click', async function onInstallClick(e) {
      e.preventDefault();
      installBtn.disabled = true;
      installBtn.innerText = 'Starting...';
      progress.style.display = 'block';
      progressBar.style.width = '10%';
      progressText.innerText = 'Preparing installation...';

      try {
        // If deferredPrompt available, use it (preferred)
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          deferredPrompt = null;
          if (choice.outcome === 'accepted') {
            progressBar.style.width = '40%';
            progressText.innerText = 'Finalizing native install...';
            await ensureSWAndCacheWithProgress(progressBar, progressText);
            // Simulate short finalization
            await new Promise(r => setTimeout(r, 900));
            progressBar.style.width = '100%';
            progressText.innerText = 'App installed';
            isAppInstalled = true;
            overlay.style.display = 'none';
            showToast('App installed', `${APP_NAME} has been installed.`);
            try { window.dispatchEvent(new Event('appinstalled')); } catch(e){}
            return;
          } else {
            // User dismissed native prompt — fallback to manual caching + simulate install
            progressBar.style.width = '25%';
            progressText.innerText = 'User dismissed native prompt — using fallback install...';
            await fallbackInstallFlow(progressBar, progressText);
            progressBar.style.width = '100%';
            progressText.innerText = 'App installed (fallback)';
            overlay.style.display = 'none';
            showToast('App installed', `${APP_NAME} has been installed (fallback).`);
            isAppInstalled = true;
            try { window.dispatchEvent(new Event('appinstalled')); } catch(e){}
            return;
          }
        } else {
          // No deferredPrompt (iOS or non-support): run fallback full install via SW + cache
          progressBar.style.width = '15%';
          progressText.innerText = 'Registering service worker...';
          await fallbackInstallFlow(progressBar, progressText);
          progressBar.style.width = '100%';
          progressText.innerText = 'App installed (fallback)';
          overlay.style.display = 'none';
          showToast('App installed', `${APP_NAME} has been installed (fallback).`);
          isAppInstalled = true;
          try { window.dispatchEvent(new Event('appinstalled')); } catch(e){}
          return;
        }
      } catch (err) {
        console.error('Install modal error', err);
        progressText.innerText = 'Installation failed';
        installBtn.disabled = false;
        installBtn.innerText = 'Install App';
        showToast('Install error', 'Installation encountered an error. Check console for details.');
      }
    });
  }

  async function fallbackInstallFlow(progressBar, progressText) {
    try {
      progressText.innerText = 'Registering service worker...';
      const reg = await registerServiceWorker();
      progressBar.style.width = '35%';
      progressText.innerText = 'Caching app files...';
      // Ask SW to cache resources (postMessage)
      try {
        if (reg && reg.active) reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS });
      } catch (e) {}
      await cacheResourcesFromPage(PRECACHE_URLS);
      progressBar.style.width = '95%';
      progressText.innerText = 'Finalizing...';
      await new Promise(r => setTimeout(r, 700));
      progressBar.style.width = '100%';
      progressText.innerText = 'App files cached';
    } catch (err) {
      console.error('fallbackInstallFlow error', err);
      progressText.innerText = 'Installation encountered issues — offline may be limited';
    }
  }

  function showToast(title, message, secs = 3.5) {
    const toast = createEl('div', { style: {
      position: 'fixed', right: '16px', bottom: '16px', background: '#111827', color: '#fff', padding: '10px 14px',
      borderRadius: '10px', zIndex: 2147483648, boxShadow: '0 6px 20px rgba(0,0,0,0.4)', fontFamily: 'Inter, sans-serif'
    }});
    toast.innerHTML = `<strong>${title}</strong><div style="opacity:0.9;margin-top:6px">${message}</div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), secs * 1000);
  }

  /* =========================
     Cache resources via Cache API (page fallback)
     ========================= */
  async function cacheResourcesFromPage(urls = PRECACHE_URLS) {
    if (!('caches' in window)) {
      console.warn('Cache API not available.');
      return false;
    }
    try {
      const cache = await caches.open(CACHE_NAME);
      const toCache = Array.from(new Set((urls || []).filter(u => typeof u === 'string')));
      await cache.addAll(toCache);
      console.info('Resources cached via Cache API:', toCache);
      return true;
    } catch (err) {
      console.warn('Failed to cache resources via page:', err);
      return false;
    }
  }

  async function ensureSWAndCacheWithProgress(progressBar, progressText) {
    try {
      progressText.innerText = 'Ensuring service worker...';
      const reg = swRegistration || await registerServiceWorker();
      if (reg && reg.active) {
        if (progressBar) progressBar.style.width = '50%';
        progressText.innerText = 'Caching app files...';
        try { reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS }); } catch(e){}
        await cacheResourcesFromPage(PRECACHE_URLS);
        if (progressBar) progressBar.style.width = '100%';
        progressText.innerText = 'App files cached';
        return true;
      } else {
        await cacheResourcesFromPage(PRECACHE_URLS);
        if (progressBar) progressBar.style.width = '100%';
        progressText.innerText = 'App files cached (no service worker active)';
        return true;
      }
    } catch (e) {
      console.warn('ensureSWAndCacheWithProgress error', e);
      return false;
    }
  }

  /* =========================
     Beforeinstallprompt & appinstalled handlers
     ========================= */
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.info('beforeinstallprompt captured.');
    // Show custom install modal immediately for a friendly UX
    ensureInstallModalExists();
    setTimeout(() => {
      const modal = $('exness-pwa-install-modal');
      if (modal && !isAppInstalled) modal.style.display = 'flex';
    }, 700);
  });

  window.addEventListener('appinstalled', (evt) => {
    console.info('PWA installed event:', evt);
    isAppInstalled = true;
    showToast('App Installed', `${APP_NAME} installed`);
  });

  /* =========================
     Show a full-screen install prompt on load (best-effort)
     ========================= */
  function showInstallModalOnLoad() {
    ensureInstallModalExists();
    const modal = $('exness-pwa-install-modal');
    if (!modal) return;
    // If beforeinstallprompt was already fired and captured, we will show the modal (deferredPrompt)
    // If not, still show modal with instructions for iOS users.
    modal.style.display = 'flex';
    const progress = $('exness-pwa-progress');
    if (progress) progress.style.display = 'none';
    const bar = $('exness-pwa-progress-bar'); if (bar) bar.style.width = '0%';
    const t = $('exness-pwa-progress-text'); if (t) t.innerText = 'Ready to install';
  }

  /* =========================
     Wiring for page buttons -> 15s simulated loader + redirect
     ========================= */
  function simulateLoadAndRedirect(destination = './AI-Trading-Bot.html', message = 'Preparing...') {
    try {
      showLoading(message + ' This may take ~15 seconds...');
      setTimeout(() => {
        hideLoading();
        // Redirect to the destination page
        window.location.href = destination;
      }, 15000);
    } catch (err) {
      console.error('simulateLoadAndRedirect error', err);
      hideLoading();
    }
  }

  function hookFastRedirectButtons() {
    // IDs used in the user's page; attach handlers if present
    const startTrialIds = ['start-free-trial-btn-desktop', 'start-free-trial-btn-mobile', 'hero-start-free-trial-btn'];
    const loginIdIds = ['login-id-btn-desktop', 'login-id-btn-mobile'];
    const connectPortfolioIds = ['connect-portfolio-btn-desktop', 'connect-portfolio-btn-mobile', 'hero-connect-portfolio-btn'];

    const attachHandler = (ids, msg) => {
      ids.forEach(id => {
        const el = $(id);
        if (el) {
          el.removeEventListener('click', el._exnessInstallClickHandler);
          el._exnessInstallClickHandler = (e) => {
            e && e.preventDefault && e.preventDefault();
            simulateLoadAndRedirect('./AI-Trading-Bot.html', msg);
          };
          el.addEventListener('click', el._exnessInstallClickHandler);
        }
      });
    };

    attachHandler(startTrialIds, 'Starting your free trial and provisioning AI Trading Bot...');
    attachHandler(loginIdIds, 'Authenticating Login ID and preparing the Trading Bot...');
    attachHandler(connectPortfolioIds, 'Connecting your portfolio to the AI Trading Bot...');
  }

  /* =========================
     Init TradingView + market data (kept as in prior script)
     ========================= */
  // Minimal market loader: fetch top coins and (if available) init TradingView symbol
  async function fetchTopCoinsAndInit(tvContainerId = 'tradingview-chart', listContainerId = 'top-coins-list') {
    const coinsContainer = $(listContainerId);
    try {
      const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false&price_change_percentage=24h');
      if (!res.ok) throw new Error('Network response not ok');
      const coins = await res.json();

      // render coin list if container exists
      if (coinsContainer) {
        coinsContainer.innerHTML = '';
        coins.forEach((coin, i) => {
          const div = createEl('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '8px', cursor: 'pointer', borderRadius: '8px' }});
          div.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><img src="${coin.image}" alt="${coin.symbol}" style="width:28px;height:28px;border-radius:50%"><div><div style="font-weight:600">${coin.name}</div><div style="font-size:12px;color:#9AA4B2">${coin.symbol.toUpperCase()}</div></div></div><div style="text-align:right"><div style="font-weight:700">$${coin.current_price.toLocaleString()}</div><div style="font-size:12px;color:${coin.price_change_percentage_24h >= 0 ? '#16C784' : '#EA3943'}">${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(2) + '%' : '-'}</div></div>`;
          div.addEventListener('click', () => {
            try { if (window.TradingView && typeof window.TradingView.widget === 'function') {
              // Attempt to update global widget if available (many embed scripts vary)
              initTradingViewWidget(`BINANCE:${coin.symbol.toUpperCase()}USDT`, tvContainerId);
            } } catch(e){}
          });
          coinsContainer.appendChild(div);
        });
      }

      // Initialize TradingView with first coin by default (if TradingView loaded)
      if (coins.length > 0) {
        initTradingViewWidget(`BINANCE:${coins[0].symbol.toUpperCase()}USDT`, tvContainerId);
      } else {
        initTradingViewWidget('BINANCE:BTCUSDT', tvContainerId);
      }
    } catch (err) {
      console.warn('fetchTopCoinsAndInit error', err);
      if (coinsContainer) coinsContainer.innerHTML = '<div style="color:#EA3943">Failed to load market data.</div>';
      initTradingViewWidget('BINANCE:BTCUSDT', tvContainerId);
    }
  }

  // Basic wrapper to initialize TradingView if available
  let tvWidgetInstance = null;
  function initTradingViewWidget(symbol = 'BINANCE:BTCUSDT', containerId = 'tradingview-chart') {
    const container = $(containerId);
    if (!container) return;
    // If TradingView 'widget' function exists, create the widget. Implementation details vary depending on embed script.
    // We will attempt a common pattern; if not available the embed script added in init will handle it.
    try {
      if (window.TradingView && typeof window.TradingView.widget === 'function') {
        // Remove previous
        container.innerHTML = '';
        tvWidgetInstance = new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: 'D',
          timezone: 'Etc/UTC',
          theme: 'dark',
          style: '1',
          locale: 'en',
          container_id: containerId,
        });
      }
    } catch (err) {
      console.warn('initTradingViewWidget error', err);
    }
  }

  /* =========================
     Initialization on load
     ========================= */
  window.addEventListener('load', async () => {
    try {
      // 1) Create manifest
      ensureManifest();

      // 2) Register SW (try server SW or inline blob)
      await registerServiceWorker();

      // 3) Create install modal (and show on load)
      ensureInstallModalExists();
      // Show it immediately to satisfy the requirement "Onload it shows the Install app prompt"
      // If beforeinstallprompt fires shortly after, deferredPrompt will be captured and used on Install click.
      setTimeout(() => {
        const modal = $('exness-pwa-install-modal');
        if (modal && !isAppInstalled) modal.style.display = 'flex';
      }, 600);

      // 4) Wire quick redirect buttons (Connect Portfolio / Login / Start free trial)
      hookFastRedirectButtons();

      // 5) Insert TradingView script and fetch market data when ready
      const tvScript = document.createElement('script');
      tvScript.src = 'https://s3.tradingview.com/tv.js';
      tvScript.async = true;
      tvScript.onload = () => {
        fetchTopCoinsAndInit();
      };
      tvScript.onerror = () => {
        console.warn('TradingView script failed to load; market data will still be fetched.');
        fetchTopCoinsAndInit();
      };
      document.head.appendChild(tvScript);

      // 6) If app already in standalone mode, treat as installed
      try {
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
          isAppInstalled = true;
        } else if ('standalone' in window.navigator && window.navigator.standalone) {
          isAppInstalled = true;
        }
      } catch (e){}

      // 7) Listen for messages from SW (cache events)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('message', evt => {
          const data = evt.data || {};
          if (data && data.type === 'cached') {
            showToast('Cached', 'App files were cached for offline use.');
          } else if (data && data.type === 'cache_failed') {
            showToast('Cache failed', 'Some files failed to cache.');
          }
        });
      }
    } catch (err) {
      console.error('PWA init error', err);
    }
  });

  /* =========================
     Expose helpers for debug
     ========================= */
  window.exnessPwa = {
    showLoading,
    hideLoading,
    ensureManifest,
    registerServiceWorker,
    handleInstallApp: function () {
      // Show install modal if present
      ensureInstallModalExists();
      const modal = $('exness-pwa-install-modal');
      if (modal) modal.style.display = 'flex';
    }
  };

  /* =========================
     Helper: attempt to cache pages on demand (public)
     ========================= */
  window.exnessPwa.cacheAppFiles = async function () {
    try {
      await cacheResourcesFromPage(PRECACHE_URLS);
      showToast('Cached', 'App pages cached for offline use.');
    } catch (e) {
      console.warn('cacheAppFiles failed', e);
    }
  };

  /* =========================
     Utility: attach install button(s) in page if present
     ========================= */
  // If page provides elements with common IDs, wire them to open the modal
  const installButtonIds = ['get-app-btn', 'install-pwa', 'getApp', 'get-mobile-app', 'install-app-btn-mobile', 'install-app-btn-desktop', 'getAppButton', 'install-pwa-btn'];
  installButtonIds.forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        ensureInstallModalExists();
        const modal = $('exness-pwa-install-modal');
        if (modal) modal.style.display = 'flex';
      });
    }
  });

})();
</script>
</body>
</html>
