<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Exness Auto-Trading Bot</title>
  <meta name="theme-color" content="#0B1720">

  <!-- App icon placeholder -->
  <link rel="icon" href="https://placehold.co/64x64/00A389/ffffff?text=EX" sizes="64x64" />
  <style>
    /* Basic reset & fonts */
    :root{
      --bg:#071017;
      --panel:#0d1b22;
      --muted:#98A6B0;
      --accent:#00A389;
      --accent-2:#F7C948;
      --glass: rgba(255,255,255,0.03);
      --card:#0f2a33;
      --radius:12px;
      --text:#E6F0F3;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,#041018 0%, #071622 100%);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    /* Header */
    header.app-header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);position:sticky;top:0;z-index:40;border-bottom:1px solid rgba(255,255,255,0.02)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:44px;height:44px;border-radius:8px;object-fit:cover}
    .brand .title{font-weight:700;font-size:18px}
    nav.header-nav{display:flex;gap:14px;align-items:center}
    .btn{background:var(--accent);color:#001;border-radius:10px;padding:9px 14px;font-weight:700;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);font-weight:600}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .panel{background:var(--panel);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    /* Layout */
    .container{max-width:1200px;margin:28px auto;padding:0 18px}
    .hero{display:grid;grid-template-columns:1fr 420px;gap:22px;align-items:center}
    .hero .content h1{font-size:36px;margin:0 0 12px;line-height:1.05}
    .hero .content p{color:var(--muted);margin:0 0 16px}
    .ctas{display:flex;gap:12px;margin-top:12px}
    .market-overview{margin-top:22px;display:flex;gap:16px}
    .market-left{flex:1;display:flex;flex-direction:column;gap:12px}
    .market-right{width:420px}
    /* Market list */
    .coins-list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .coin{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .coin img{width:36px;height:36px;border-radius:8px}
    .coin .meta{display:flex;flex-direction:column}
    .coin .meta .name{font-weight:700}
    .coin .meta .price{color:var(--muted);font-size:13px}
    .ticker{display:flex;gap:8px;align-items:center;margin-top:8px}
    .ticker .tick{padding:6px 8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
    /* Footer */
    footer.global-footer{margin-top:36px;padding:28px;border-top:1px solid rgba(255,255,255,0.02);color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    footer .links{display:flex;gap:12px}
    /* Modal and chart container */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:60}
    .modal .card{width:920px;max-width:96%;background:linear-gradient(180deg,#071617,#071b20);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    .close-x{float:right;cursor:pointer;color:var(--muted)}
    .chart-area{height:520px}
    /* More options dropdown */
    .more-dropdown{position:relative}
    .more-panel{position:absolute;right:0;top:46px;background:var(--panel);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:none;min-width:220px;box-shadow:0 8px 30px rgba(2,6,10,0.6)}
    .more-panel button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--text);cursor:pointer}
    /* Loading overlay */
    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(2,6,10,0.85));z-index:999}
    .spinner{width:88px;height:88px;border-radius:12px;background:var(--panel);display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
    .spinner .dot{width:18px;height:18px;border-radius:50%;background:var(--accent);animation:spin 1.1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    /* Responsive */
    @media (max-width:980px){.hero{grid-template-columns:1fr;}.market-right{width:100%}.coins-list{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Loading overlay used for 15s redirect flows -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner">
      <div style="font-weight:700;margin-bottom:10px">Processing...</div>
      <div class="dot"></div>
    </div>
  </div>

  <!-- Chart modal (TradingView) -->
  <div id="chart-modal" class="modal" aria-hidden="true">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800">Market chart</div>
        <div class="close-x" id="close-chart">✕</div>
      </div>
      <div id="tv-chart" class="chart-area" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Install modal will be created by JS with id pwa-install-modal -->

  <header class="app-header">
    <div class="brand">
      <img src="https://placehold.co/512x512/00A389/ffffff?text=EX" alt="EX" id="app-logo">
      <div>
        <div class="title">Exness Auto-Trading Bot</div>
        <div style="font-size:12px;color:var(--muted)">Automated trading assistant</div>
      </div>
    </div>

    <nav class="header-nav">
      <div class="panel" style="padding:10px 12px;border-radius:10px;display:flex;gap:8px;align-items:center">
        <div style="font-weight:700;margin-right:8px">Market overview</div>
        <div class="ticker">
          <div class="tick" id="ticker-btc">BTC —</div>
          <div class="tick" id="ticker-eth">ETH —</div>
          <div class="tick" id="ticker-bnb">BNB —</div>
        </div>
      </div>

      <div style="width:12px"></div>

      <button id="connect-portfolio" class="btn ghost">Connect Portfolio</button>
      <button id="start-trial" class="btn">Start Free Trial</button>
      <button id="login-id" class="btn secondary">Login ID</button>

      <div class="more-dropdown">
        <button id="more-btn" class="btn ghost" style="margin-left:6px">More ▾</button>
        <div id="more-panel" class="more-panel" role="menu" aria-hidden="true">
          <button id="more-connect-portfolio">Connect Portfolio</button>
          <button id="more-login">Login ID</button>
          <button id="more-support">Support</button>
          <button id="more-connect-wallet">Connect Wallet</button>
          <button id="more-start-trial" style="font-weight:800;color:var(--accent)">Start Free Trial</button>
          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:8px 0">
          <button id="install-pwa" data-install-pwa>Install App</button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container" id="landing-page">
    <section class="hero">
      <div class="content">
        <h1>Auto-Trading Bot — connect your portfolio, trade smarter</h1>
        <p>Automated strategies, deep market scans and quick execution. Build or choose AI trading strategies and run them through your Exness accounts. Trade with precision, reduce manual friction, and stay ahead of market disruptions.</p>
        <div class="ctas">
          <button id="hero-start-trial" class="btn">Start Free Trial</button>
          <button id="hero-login" class="btn ghost">Login ID</button>
          <button id="hero-connect-wallet" class="btn secondary">Connect Wallet</button>
        </div>

        <div class="market-overview">
          <div class="market-left panel">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div style="font-weight:800">Market overview</div>
              <div style="color:var(--muted);font-size:13px">Live | Updated every 30s</div>
            </div>

            <div id="coins" style="margin-top:12px" class="coins-list">
              <!-- coins populated by JS -->
            </div>
          </div>

          <div class="market-right">
            <div class="panel">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div style="font-weight:800">Live price performance</div>
                <div style="color:var(--muted);font-size:13px">Click a coin to open chart</div>
              </div>
              <div id="mini-charts" style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div id="mini-btc" class="panel" style="padding:10px;border-radius:10px;cursor:pointer">
                  <div style="font-weight:700">Bitcoin (BTC)</div>
                  <div id="btc-price" style="color:var(--muted);font-size:14px">$—</div>
                </div>
                <div id="mini-eth" class="panel" style="padding:10px;border-radius:10px;cursor:pointer">
                  <div style="font-weight:700">Ethereum (ETH)</div>
                  <div id="eth-price" style="color:var(--muted);font-size:14px">$—</div>
                </div>
                <div id="mini-bnb" class="panel" style="padding:10px;border-radius:10px;cursor:pointer">
                  <div style="font-weight:700">BNB</div>
                  <div id="bnb-price" style="color:var(--muted);font-size:14px">$—</div>
                </div>
                <div id="mini-xrp" class="panel" style="padding:10px;border-radius:10px;cursor:pointer">
                  <div style="font-weight:700">Top Movers</div>
                  <div id="xrp-price" style="color:var(--muted);font-size:14px">—</div>
                </div>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="panel">
              <div style="font-weight:700;margin-bottom:8px">Top coins</div>
              <div id="top-coins" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- small promotional card on the right (hero visual) -->
      <aside>
        <div class="panel" style="padding:18px;border-radius:18px;display:flex;flex-direction:column;gap:12px;align-items:flex-start">
          <div style="font-weight:800;font-size:16px">Exness Bot</div>
          <div style="color:var(--muted);font-size:13px">Run strategies, manage risk, and deploy across accounts. Integrated with major wallets and Exness portfolio connections.</div>
          <div style="width:100%;margin-top:8px">
            <div style="font-weight:700">Performance snapshot</div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <div style="flex:1">
                <div style="font-size:12px;color:var(--muted)">Total P&L</div>
                <div style="font-weight:800">+12.6%</div>
              </div>
              <div style="flex:1">
                <div style="font-size:12px;color:var(--muted)">Active Bots</div>
                <div style="font-weight:800">3</div>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:8px;width:100%">
            <button id="aside-start" class="btn" style="flex:1">Start Trial</button>
            <button id="aside-login" class="btn ghost" style="flex:1">Sign in</button>
          </div>
        </div>
      </aside>
    </section>

    <footer class="global-footer">
      <div>&copy; <span id="year"></span> Exness Auto-Trading Bot</div>
      <div class="links">
        <a href="#" id="footer-support" style="color:var(--muted)">Support</a>
        <a href="#" id="footer-privacy" style="color:var(--muted)">Privacy</a>
        <a href="#" id="get-app-btn" style="color:var(--muted)">Get App</a>
      </div>
    </footer>
  </main>

<script>
(function initPWAInstaller() {
  'use strict';

  /* =========================
     Configuration (adapted)
     ========================= */
  const CACHE_NAME = 'exness-auto-trading-pwa-v1';
  const PRECACHE_URLS = ['/', '/index.html', '/AI-Trading-Bot.html'];
  const APP_NAME = 'Exness Auto-Trading Bot';
  const APP_SHORT_NAME = 'ExnessBot';
  const THEME_COLOR = '#0B1720';
  const BACKGROUND_COLOR = '#071617';

  // App icon (placeholder)
  const ICON_PNG_URL = 'https://placehold.co/512x512/00A389/ffffff?text=EX';

  /* =========================
     State
     ========================= */
  let deferredPrompt = null;
  let isAppInstalled = false;
  let manifestBlobUrl = null;
  let swRegistration = null;

  /* =========================
     Small DOM helpers
     ========================= */
  function $ (id) { return document.getElementById(id); }
  function q (sel) { return document.querySelector(sel); }
  function createEl (tag, props = {}, children = []) {
    const el = document.createElement(tag);
    Object.keys(props).forEach(k => {
      if (k === 'style') Object.assign(el.style, props[k]);
      else if (k === 'attrs') Object.keys(props.attrs).forEach(a => el.setAttribute(a, props.attrs[a]));
      else el[k] = props[k];
    });
    (Array.isArray(children) ? children : [children]).forEach(c => {
      if (!c) return;
      if (typeof c === 'string') el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  }

  /* =========================
     Create or update the manifest using a blob URL.
     ========================= */
  function ensureManifest() {
    try {
      const existing = document.querySelector('link[rel="manifest"]');
      if (existing) existing.parentNode.removeChild(existing);

      const manifest = {
        name: APP_NAME,
        short_name: APP_SHORT_NAME,
        start_url: '/index.html',
        scope: '/',
        display: 'standalone',
        orientation: 'portrait',
        theme_color: THEME_COLOR,
        background_color: BACKGROUND_COLOR,
        icons: [
          { src: ICON_PNG_URL, sizes: '192x192', type: 'image/png', purpose: 'any' },
          { src: ICON_PNG_URL, sizes: '512x512', type: 'image/png', purpose: 'maskable any' }
        ],
        description: 'Exness Auto-Trading Bot — automated trading with portfolio connect and live markets.'
      };

      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      manifestBlobUrl = URL.createObjectURL(blob);
      const link = createEl('link', { attrs: { rel: 'manifest', href: manifestBlobUrl }});
      document.head.appendChild(link);
      console.info('PWA manifest injected/updated with PNG icon.');
    } catch (err) {
      console.error('Failed to create manifest:', err);
    }
  }

  /* =========================
     Service Worker registration (with inline fallback)
     ========================= */
  async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
      console.warn('Service Worker not supported by this browser.');
      return null;
    }

    try {
      const reg = await navigator.serviceWorker.register('/sw.js');
      swRegistration = reg;
      console.info('Service Worker registered from /sw.js');
      await waitForServiceWorkerReady();
      return swRegistration;
    } catch (err) {
      console.warn('Failed to register /sw.js; falling back to inline SW. Error:', err);
    }

    // Inline SW fallback
    const swCode = `
      const CACHE_NAME = '${CACHE_NAME}';
      const PRECACHE = ${JSON.stringify(PRECACHE_URLS)};

      self.addEventListener('install', (evt) => {
        evt.waitUntil((async () => {
          try {
            const c = await caches.open(CACHE_NAME);
            await c.addAll(PRECACHE);
          } catch (e) {}
          self.skipWaiting();
        })());
      });

      self.addEventListener('activate', (evt) => {
        evt.waitUntil((async () => {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => k === CACHE_NAME ? Promise.resolve() : caches.delete(k)));
          await self.clients.claim();
        })());
      });

      self.addEventListener('fetch', (evt) => {
        evt.respondWith((async () => {
          try {
            const cache = await caches.open(CACHE_NAME);
            const cached = await cache.match(evt.request);
            if (cached) return cached;
            const response = await fetch(evt.request);
            if (evt.request.method === 'GET' && response && response.status === 200 && evt.request.url.startsWith(self.location.origin)) {
              cache.put(evt.request, response.clone()).catch(()=>{});
            }
            return response;
          } catch (err) {
            if (evt.request.mode === 'navigate') {
              const cache = await caches.open(CACHE_NAME);
              const fallback = await cache.match('/index.html') || cache.match('/AI-Trading-Bot.html');
              if (fallback) return fallback;
            }
            return new Response('Offline', { status: 503, statusText: 'Offline' });
          }
        })());
      });

      self.addEventListener('message', async (evt) => {
        const data = evt.data || {};
        if (data && data.type === 'CACHE_URLS' && Array.isArray(data.urls)) {
          try {
            const cache = await caches.open(CACHE_NAME);
            await cache.addAll(data.urls);
            const cs = await self.clients.matchAll();
            cs.forEach(c => c.postMessage({ type: 'cached', urls: data.urls }));
          } catch (e) {
            const cs = await self.clients.matchAll();
            cs.forEach(c => c.postMessage({ type: 'cache_failed', error: String(e) }));
          }
        }
      });
    `;

    try {
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const blobUrl = URL.createObjectURL(blob);
      const reg = await navigator.serviceWorker.register(blobUrl);
      swRegistration = reg;
      console.info('Inline Service Worker registered.');
      await waitForServiceWorkerReady();
      return swRegistration;
    } catch (err2) {
      console.error('Failed to register inline Service Worker:', err2);
      return null;
    }
  }

  function waitForServiceWorkerReady(timeout = 10000) {
    return new Promise((resolve) => {
      let resolved = false;
      navigator.serviceWorker.ready.then(reg => {
        if (!resolved) { resolved = true; swRegistration = reg; resolve(reg); }
      }).catch(() => {
        if (!resolved) { resolved = true; resolve(null); }
      });
      setTimeout(() => { if (!resolved) { resolved = true; resolve(null); } }, timeout);
    });
  }

  /* =========================
     Cache resources via Cache API (page-side)
     ========================= */
  async function cacheResourcesFromPage(urls = PRECACHE_URLS) {
    if (!('caches' in window)) {
      console.warn('Cache API not available.');
      return false;
    }
    try {
      const cache = await caches.open(CACHE_NAME);
      const toCache = Array.from(new Set((urls || []).filter(u => typeof u === 'string')));
      await cache.addAll(toCache);
      console.info('Resources cached via Cache API:', toCache);
      return true;
    } catch (err) {
      console.warn('Failed to cache resources via page:', err);
      return false;
    }
  }

  /* =========================
     Install modal creation (adapted branding)
     ========================= */
  function ensureInstallModalExists() {
    if ($('pwa-install-modal')) return;

    const overlay = createEl('div', {
      id: 'pwa-install-modal',
      style: {
        position: 'fixed',
        inset: '0',
        display: 'none',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'rgba(0,0,0,0.45)',
        zIndex: 2147483647
      }
    });

    const card = createEl('div', {
      id: 'pwa-install-modal-card',
      style: {
        width: '380px',
        maxWidth: '94%',
        background: 'linear-gradient(180deg,#071617,#071b20)',
        borderRadius: '14px',
        padding: '18px',
        boxShadow: '0 10px 30px rgba(0,0,0,0.5)',
        fontFamily: 'Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial',
        color: '#E6F0F3',
        border: '1px solid rgba(255,255,255,0.03)'
      }
    });

    const headerRow = createEl('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '10px' } });
    const logoImg = createEl('img', {
      attrs: { id: 'pwa-logo', src: ICON_PNG_URL, alt: 'EX' },
      style: { width: '44px', height: '44px', borderRadius: '8px', objectFit: 'cover', border: '1px solid rgba(255,255,255,0.04)' }
    });
    const title = createEl('div', { innerText: `Install ${APP_NAME}`, style: { fontSize: '18px', fontWeight: 700, color: 'var(--accent-2)' } });
    headerRow.appendChild(logoImg);
    headerRow.appendChild(title);

    const desc = createEl('div', {
      innerText: 'Install the app for faster access, offline support, and a home-screen experience. This will cache the app pages and register offline support.',
      style: { fontSize: '13px', marginTop: '6px', color: 'var(--muted)' }
    });

    const progressContainer = createEl('div', { id: 'pwa-install-progress', style: { display: 'none', marginTop: '12px' } });
    const progressOuter = createEl('div', { style: { width: '100%', height: '10px', background: '#071a1f', borderRadius: '8px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.02)' }});
    const progressBar = createEl('div', { id: 'pwa-install-progress-bar', style: { width: '0%', height: '100%', background: 'var(--accent-2)', transition: 'width 300ms ease' }});
    progressOuter.appendChild(progressBar);
    const progressText = createEl('div', { id: 'pwa-install-progress-text', innerText: 'Ready to install', style: { fontSize: '13px', marginTop: '8px', color: 'var(--muted)' }});
    progressContainer.appendChild(progressOuter);
    progressContainer.appendChild(progressText);

    const actions = createEl('div', { style: { display: 'flex', gap: '10px', justifyContent: 'flex-end', marginTop: '14px' }});
    const cancelBtn = createEl('button', { id: 'cancel-install-btn', innerText: 'Cancel', style: {
      padding: '8px 12px', borderRadius: '10px', border: '1px solid rgba(255,255,255,0.03)', background: 'transparent', color: '#E6F0F3', cursor: 'pointer', fontWeight: 600
    }});
    const installBtn = createEl('button', { id: 'install-now-btn', innerText: 'Get App', style: {
      padding: '8px 14px', borderRadius: '10px', border: '0', background: 'var(--accent-2)', color: '#071617', cursor: 'pointer', fontWeight: 800
    }});
    actions.appendChild(cancelBtn);
    actions.appendChild(installBtn);

    card.appendChild(headerRow);
    card.appendChild(desc);
    card.appendChild(progressContainer);
    card.appendChild(actions);

    overlay.appendChild(card);
    document.body.appendChild(overlay);

    // Events
    cancelBtn.addEventListener('click', hideInstallModal);
    installBtn.addEventListener('click', onInstallNowClicked);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) hideInstallModal(); });
  }

  function showInstallModal() {
    ensureInstallModalExists();
    const overlay = $('pwa-install-modal');
    if (!overlay) return;
    overlay.style.display = 'flex';
    const prog = $('pwa-install-progress'); if (prog) prog.style.display = 'none';
    const bar = $('pwa-install-progress-bar'); if (bar) bar.style.width = '0%';
    const text = $('pwa-install-progress-text'); if (text) text.innerText = 'Ready to install';
    const installBtn = $('install-now-btn'); if (installBtn) { installBtn.innerText = (deferredPrompt ? 'Install Now' : 'Get App'); installBtn.disabled = false; installBtn.style.opacity = '1'; }
  }

  function hideInstallModal() {
    const overlay = $('pwa-install-modal');
    if (!overlay) return;
    overlay.style.display = 'none';
  }

  async function onInstallNowClicked(e) {
    e && e.preventDefault && e.preventDefault();
    const installBtn = $('install-now-btn');
    const cancelBtn = $('cancel-install-btn');
    const progress = $('pwa-install-progress');
    const progressBar = $('pwa-install-progress-bar');
    const progressText = $('pwa-install-progress-text');

    if (installBtn) { installBtn.disabled = true; installBtn.style.opacity = '0.8'; installBtn.innerText = 'Starting...'; }
    if (cancelBtn) cancelBtn.disabled = true;

    // If native install prompt available, prefer that
    if (deferredPrompt) {
      try {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null; // only usable once
        if (choice.outcome === 'accepted') {
          if (progress) progress.style.display = 'block';
          if (progressBar) progressBar.style.width = '60%';
          if (progressText) progressText.innerText = 'Finalizing native install...';
          await waitForAppInstalledOrTimeout(12000);
          await ensureSWAndCacheWithProgress(progressBar, progressText);
          finalizeInstallUI(true);
          return;
        } else {
          if (progress) progress.style.display = 'block';
          if (progressBar) progressBar.style.width = '20%';
          if (progressText) progressText.innerText = 'Falling back to offline install...';
          await fallbackInstallSequence(progressBar, progressText);
          finalizeInstallUI(true, 'installed (fallback)');
          return;
        }
      } catch (err) {
        console.warn('deferredPrompt.prompt() error', err);
        await fallbackInstallSequence(progressBar, progressText);
        finalizeInstallUI(true, 'installed (fallback)');
        return;
      }
    }

    // No native prompt -> run fallback
    if (progress) progress.style.display = 'block';
    if (progressBar) progressBar.style.width = '10%';
    if (progressText) progressText.innerText = 'Registering service worker...';
    await fallbackInstallSequence(progressBar, progressText);
    finalizeInstallUI(true, 'installed (fallback)');
  }

  function finalizeInstallUI(success = true, extraText = '') {
    const installBtn = $('install-now-btn');
    const cancelBtn = $('cancel-install-btn');
    const progressText = $('pwa-install-progress-text');

    if (installBtn) {
      installBtn.innerText = success ? 'App installed' : 'Install';
      installBtn.disabled = true;
      installBtn.style.background = success ? '#16A34A' : '';
    }
    if (cancelBtn) cancelBtn.disabled = false;
    if (progressText) progressText.innerText = success ? `App installed${extraText ? ' — ' + extraText : ''}` : 'Installation failed';
    isAppInstalled = !!success;

    try {
      const toast = createEl('div', { innerText: success ? `${APP_NAME} installed` : 'Install failed', style: {
        position: 'fixed', right: '16px', bottom: '16px', background: '#071617', color: '#fff', padding: '10px 14px', borderRadius: '10px', zIndex: 2147483648, boxShadow: '0 6px 20px rgba(0,0,0,0.4)'
      }});
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    } catch (e) {}

    setTimeout(hideInstallModal, 1400);
  }

  async function fallbackInstallSequence(progressBar, progressText) {
    try {
      if (progressText) progressText.innerText = 'Registering service worker...';
      const reg = await registerServiceWorker();
      if (reg && reg.active) {
        if (progressBar) progressBar.style.width = '35%';
        if (progressText) progressText.innerText = 'Preparing app files...';
        try {
          reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS });
        } catch (e) {}
        await cacheResourcesFromPage(PRECACHE_URLS);
        if (progressBar) progressBar.style.width = '90%';
        if (progressText) progressText.innerText = 'Finalizing...';
        await new Promise(r => setTimeout(r, 700));
        maybeShowIOSInstructions();
      } else {
        if (progressBar) progressBar.style.width = '45%';
        if (progressText) progressText.innerText = 'Caching app resources...';
        await cacheResourcesFromPage(PRECACHE_URLS);
        if (progressBar) progressBar.style.width = '95%';
        if (progressText) progressText.innerText = 'Finalizing...';
        await new Promise(r => setTimeout(r, 600));
        maybeShowIOSInstructions();
      }
    } catch (err) {
      console.error('fallbackInstallSequence error:', err);
      if (progressText) progressText.innerText = 'Installation encountered issues — offline may be limited.';
    }
  }

  function maybeShowIOSInstructions() {
    const ua = navigator.userAgent || '';
    if (/iphone|ipad|ipod/i.test(ua) && !window.matchMedia('(display-mode: standalone)').matches) {
      const t = $('pwa-install-progress-text');
      if (t) t.innerText = 'Tap the Share button → Add to Home Screen to install on iOS';
    }
  }

  async function ensureSWAndCacheWithProgress(progressBar, progressText) {
    try {
      if (progressText) progressText.innerText = 'Ensuring service worker...';
      const reg = swRegistration || await registerServiceWorker();
      if (reg && reg.active) {
        if (progressBar) progressBar.style.width = '50%';
        progressText && (progressText.innerText = 'Caching app files...');
        try { reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS }); } catch(e){}
        await cacheResourcesFromPage(PRECACHE_URLS);
        if (progressBar) progressBar.style.width = '100%';
        progressText && (progressText.innerText = 'App files cached');
        return true;
      } else {
        await cacheResourcesFromPage(PRECACHE_URLS);
        if (progressBar) progressBar.style.width = '100%';
        if (progressText) progressText.innerText = 'App files cached (no service worker active)';
        return true;
      }
    } catch (e) {
      console.warn('ensureSWAndCacheWithProgress error', e);
      return false;
    }
  }

  function waitForAppInstalledOrTimeout(timeoutMs = 15000) {
    return new Promise((resolve) => {
      if (isAppInstalled) return resolve();
      let done = false;
      function onInstalled() {
        if (done) return;
        done = true;
        window.removeEventListener('appinstalled', onInstalled);
        resolve();
      }
      window.addEventListener('appinstalled', onInstalled);
      setTimeout(() => {
        if (done) return;
        done = true;
        window.removeEventListener('appinstalled', onInstalled);
        resolve();
      }, timeoutMs);
    });
  }

  function setupSWMessageHandler() {
    if (!('serviceWorker' in navigator)) return;
    navigator.serviceWorker.addEventListener('message', (evt) => {
      const data = evt.data || {};
      if (data && data.type) {
        const progressBar = $('pwa-install-progress-bar');
        const progressText = $('pwa-install-progress-text');
        if (data.type === 'precached' || data.type === 'cached') {
          if (progressBar) progressBar.style.width = '100%';
          if (progressText) progressText.innerText = 'App files cached';
          setTimeout(() => finalizeInstallUI(true), 700);
        } else if (data.type === 'cache_failed') {
          if (progressText) progressText.innerText = 'Caching failed — offline may be limited';
          finalizeInstallUI(true, 'partial');
        }
      }
    });
  }

  function setupGetAppButtons() {
    const handler = (e) => {
      e && e.preventDefault && e.preventDefault();
      showInstallModal();
    };

    const ids = ['get-app-btn', 'get-mobile-app', 'getApp', 'getMobileApp', 'install-pwa', 'getAppButton', 'get-app'];
    ids.forEach(id => {
      const el = $ (id) || document.querySelector(`#${id}`);
      if (el) {
        try { el.removeEventListener('click', handler); } catch (e) {}
        el.addEventListener('click', handler);
      }
    });

    const nodes = document.querySelectorAll('[data-install-pwa]');
    nodes.forEach(n => { n.removeEventListener('click', handler); n.addEventListener('click', handler); });

    window.openStoreOrPrompt = function () {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('android')) {
        window.open('https://play.google.com/store/apps', '_blank');
      } else if (/(iphone|ipad|ipod)/i.test(navigator.userAgent)) {
        window.open('https://apps.apple.com/', '_blank');
      } else {
        showInstallModal();
      }
    };
  }

  /* =========================
     Attach other buttons (auth/connect)
     ========================= */
  async function tryConnectWallet(btn) {
    if (!btn) return;
    const orig = btn.innerText;
    try {
      btn.innerText = 'Connecting...';
      btn.disabled = true;
      if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        btn.innerText = accounts && accounts[0] ? `Connected` : 'Connected';
      } else {
        alert('No injected Ethereum provider found. Install MetaMask or another Web3 wallet.');
        btn.innerText = orig;
        btn.disabled = false;
      }
    } catch (e) {
      console.error('Wallet connect error', e);
      btn.innerText = orig;
      btn.disabled = false;
      alert('Wallet connection failed or cancelled.');
    }
  }

  /* =========================
     Loading & redirect helpers (15s flows)
     ========================= */
  function showLoadingAndRedirect(seconds, redirectPath) {
    const overlay = $('loading-overlay');
    if (!overlay) return;
    overlay.style.display = 'flex';
    let t = seconds;
    const interval = setInterval(()=> {
      t--;
      if (t <= 0) {
        clearInterval(interval);
        overlay.style.display = 'none';
        window.location.href = redirectPath; // redirect after load
      }
    }, 1000);
  }

  /* =========================
     Market data (CoinGecko)
     ========================= */
  async function loadTopCoins() {
    try {
      const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=12&page=1&sparkline=false&price_change_percentage=24h';
      const res = await fetch(url);
      if (!res.ok) throw new Error('CoinGecko fetch failed');
      const coins = await res.json();
      renderCoins(coins);
      renderTopCoins(coins.slice(0,6));
      updateMiniPrices(coins);
    } catch (err) {
      console.error('Failed to load coins', err);
    }
  }

  function renderCoins(coins) {
    const container = $('coins');
    if (!container) return;
    container.innerHTML = '';
    coins.forEach(c => {
      const div = createEl('div', { attrs: { class: 'coin' }});
      div.addEventListener('click', () => openChartForCoin(c));
      const img = createEl('img', { attrs: { src: c.image, alt: c.symbol }});
      const meta = createEl('div', { attrs: { class: 'meta' }});
      const name = createEl('div', { attrs: { class: 'name' }, innerText: `${c.name} (${c.symbol.toUpperCase()})` });
      const price = createEl('div', { attrs: { class: 'price' }, innerText: `$${Number(c.current_price).toLocaleString()}`});
      meta.appendChild(name);
      meta.appendChild(price);
      div.appendChild(img);
      div.appendChild(meta);
      container.appendChild(div);
    });
  }

  function renderTopCoins(coinsSlice) {
    const target = $('top-coins');
    if (!target) return;
    target.innerHTML = '';
    coinsSlice.forEach(c => {
      const row = createEl('div', { style: { display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px dashed rgba(255,255,255,0.02)' }});
      const left = createEl('div', {});
      left.appendChild(createEl('div',{ innerText: `${c.name} (${c.symbol.toUpperCase()})`, style: { fontWeight:700 } }));
      left.appendChild(createEl('div',{ innerText: `Market cap: $${Number(c.market_cap).toLocaleString()}`, style: { color:'var(--muted)', fontSize:'12px' } }));
      const right = createEl('div', { innerText: `$${Number(c.current_price).toLocaleString()}`, style: { fontWeight:700 }});
      row.appendChild(left);
      row.appendChild(right);
      target.appendChild(row);
    });
  }

  function updateMiniPrices(coins) {
    const find = (id) => coins.find(c => c.symbol === id);
    const btc = coins.find(c => c.symbol === 'btc');
    const eth = coins.find(c => c.symbol === 'eth');
    const bnb = coins.find(c => c.symbol === 'bnb');
    if (btc && $('btc-price')) $('btc-price').textContent = `$${Number(btc.current_price).toLocaleString()}`;
    if (eth && $('eth-price')) $('eth-price').textContent = `$${Number(eth.current_price).toLocaleString()}`;
    if (bnb && $('bnb-price')) $('bnb-price').textContent = `$${Number(bnb.current_price).toLocaleString()}`;
    // ticker small top values for header
    if (btc && $('ticker-btc')) $('ticker-btc').textContent = `BTC ${formatChange(btc.price_change_percentage_24h)}`;
    if (eth && $('ticker-eth')) $('ticker-eth').textContent = `ETH ${formatChange(eth.price_change_percentage_24h)}`;
    if (bnb && $('ticker-bnb')) $('ticker-bnb').textContent = `BNB ${formatChange(bnb.price_change_percentage_24h)}`;
  }

  function formatChange(num){
    if (num === undefined || num === null) return '—';
    const v = Number(num).toFixed(2);
    return (v>=0?'+':'') + v + '%';
  }

  /* =========================
     TradingView chart integration
     ========================= */
  let tvWidget = null;
  function loadTradingViewScriptIfNeeded(callback) {
    if (window.TradingView) { callback && callback(); return; }
    const s = document.createElement('script');
    s.src = 'https://s3.tradingview.com/tv.js';
    s.onload = () => { callback && callback(); };
    s.onerror = () => console.warn('TradingView script load failed.');
    document.head.appendChild(s);
  }

  function openChartForCoin(coin) {
    // coin: coin object from CoinGecko; map id to TradingView symbol if possible
    const mapping = {
      'btc': 'COINBASE:BTCUSD',
      'eth': 'COINBASE:ETHUSD',
      'bnb': 'BINANCE:BNBUSDT',
      'xrp': 'BITFINEX:XRPUSD',
      'ada': 'BINANCE:ADAUSDT',
      'doge': 'BINANCE:DOGEUSDT'
    };
    const symbol = mapping[coin.symbol] || (`COINBASE:${coin.symbol.toUpperCase()}USD`);
    loadTradingViewScriptIfNeeded(() => {
      openChartModal(symbol, coin.name);
    });
  }

  function openChartModal(symbol, title) {
    const modal = $('chart-modal'),
    tvContainer = $('tv-chart');
    if (!modal || !tvContainer) return;
    modal.style.display = 'flex';
    tvContainer.innerHTML = '';
    // create widget
    try {
      // remove old if present
      if (window.tvWidgetInstance && window.tvWidgetInstance.remove) {
        try { window.tvWidgetInstance.remove(); } catch(e){}
        window.tvWidgetInstance = null;
      }
    } catch(e){}
    // Create new
    try {
      window.tvWidgetInstance = new TradingView.widget({
        autosize: true,
        symbol: symbol,
        interval: '60',
        timezone: 'Etc/UTC',
        theme: 'Dark',
        style: '1',
        locale: 'en',
        toolbar_bg: '#0b171b',
        enable_publishing: false,
        withdateranges: true,
        hide_side_toolbar: false,
        allow_symbol_change: true,
        save_image: false,
        container_id: 'tv-chart'
      });
    } catch (err) {
      console.error('TV widget error', err);
      tvContainer.innerText = 'Unable to load chart';
    }
  }

  /* =========================
     UI wiring on DOM ready
     ========================= */
  function initUiActions() {
    // More button toggle
    const moreBtn = $('more-btn');
    const morePanel = $('more-panel');
    if (moreBtn && morePanel) {
      moreBtn.addEventListener('click', (e) => {
        morePanel.style.display = morePanel.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', (ev) => {
        if (!morePanel.contains(ev.target) && ev.target !== moreBtn) {
          morePanel.style.display = 'none';
        }
      });
    }

    // Wire main CTAs to 15s flows that redirect to AI-Trading-Bot.html
    const trialButtons = ['start-trial','hero-start-trial','aside-start','more-start-trial','more-start-trial','more-start-trial'];
    const loginButtons = ['login-id','hero-login','aside-login','more-login'];
    trialButtons.forEach(id => {
      const el = $(id);
      if (el) el.addEventListener('click', () => {
        showLoadingAndRedirect(15, '/AI-Trading-Bot.html');
      });
    });
    loginButtons.forEach(id => {
      const el = $(id);
      if (el) el.addEventListener('click', () => {
        showLoadingAndRedirect(15, '/AI-Trading-Bot.html');
      });
    });

    // Connect portfolio
    const connectPortfolio = $('connect-portfolio');
    if (connectPortfolio) connectPortfolio.addEventListener('click', () => {
      alert('Connect Portfolio — this would open portfolio connection flow (not implemented in this prototype).');
    });
    const moreConnectPortfolio = $('more-connect-portfolio');
    if (moreConnectPortfolio) moreConnectPortfolio.addEventListener('click', () => {
      alert('Connect Portfolio — chosen from More menu.');
    });

    // Support button
    const moreSupport = $('more-support');
    if (moreSupport) moreSupport.addEventListener('click', () => {
      window.open('mailto:support@example.com','_self');
    });

    // Connect wallet from more
    const moreConnectWallet = $('more-connect-wallet');
    if (moreConnectWallet) moreConnectWallet.addEventListener('click', () => {
      tryConnectWallet(moreConnectWallet);
    });

    // hero connect wallet
    const heroWallet = $('hero-connect-wallet');
    if (heroWallet) heroWallet.addEventListener('click', () => tryConnectWallet(heroWallet));

    // small mini chart opens
    ['mini-btc','mini-eth','mini-bnb','mini-xrp'].forEach(id => {
      const el = $(id);
      if (el) el.addEventListener('click', () => {
        const mapping = { 'mini-btc': 'COINBASE:BTCUSD', 'mini-eth':'COINBASE:ETHUSD','mini-bnb':'BINANCE:BNBUSDT','mini-xrp':'BITSTAMP:XRPUSD' };
        loadTradingViewScriptIfNeeded(()=>openChartModal(mapping[id], id));
      });
    });

    // chart modal close
    const closeChart = $('close-chart');
    if (closeChart) closeChart.addEventListener('click', ()=> {
      const modal = $('chart-modal');
      if (modal) modal.style.display = 'none';
      try{ if (window.tvWidgetInstance && window.tvWidgetInstance.remove) window.tvWidgetInstance.remove(); }catch(e){}
    });

    // install app (header/footer)
    setupGetAppButtons();

    // Footer year
    $('year').textContent = new Date().getFullYear();
  }

  /* =========================
     Small helper to show landing page on load & hide other pages
     ========================= */
  function showLandingOnLoad() {
    try {
      // hide everything except landing container element (id landing-page)
      document.querySelectorAll('main, section, article, footer').forEach(el => {
        // keep main landing-page visible
        if (el.id === 'landing-page' || el.closest('#landing-page')) {
          el.style.display = '';
        } else {
          // don't hide header
        }
      });
    } catch(e){}
  }

  /* =========================
     Initialize everything on DOM ready
     ========================= */
  function initOnDomReady() {
    // manifest
    ensureManifest();

    // create install modal
    ensureInstallModalExists();

    // register sw
    registerServiceWorker().then(reg => {
      if (reg) {
        swRegistration = reg;
        setupSWMessageHandler();
      }
    }).catch(err => console.warn('SW registration error:', err));

    // beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.info('beforeinstallprompt captured.');
      const banner = $('pwa-install-banner');
      if (banner) banner.style.display = 'flex';
    });

    // appinstalled
    window.addEventListener('appinstalled', (evt) => {
      console.info('PWA installed event', evt);
      isAppInstalled = true;
      finalizeInstallUI(true);
    });

    // setup UI
    initUiActions();

    // initial load market data
    loadTopCoins();
    setInterval(loadTopCoins, 30000);

    // show landing
    showLandingOnLoad();
  }

  // DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initOnDomReady);
  } else {
    initOnDomReady();
  }

  /* =========================
     Public helpers (debug)
     ========================= */
  window.pwaInstaller = {
    showInstallModal, hideInstallModal, ensureManifest, registerServiceWorker, cacheResourcesFromPage, isAppInstalled: () => isAppInstalled
  };

})();
</script>

</body>
</html>
