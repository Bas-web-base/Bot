<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exness Auto-Trading Bot</title>
    
    <!-- Theme Color and PWA Meta -->
    <meta name="theme-color" content="#0D1321">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- The manifest link is injected by the PWA script -->
    
    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TradingView Widget Script -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        /* Base Dark Mode Theme (Exness inspired colors) */
        :root {
            --primary-bg: #0D1321; /* Dark background */
            --secondary-bg: #12213A; /* Card/section background (Dark Blue) */
            --primary-text: #E5E7EB; /* Light text */
            --accent-color: #0077B6; /* Exness Blue */
            --accent-hover: #005A93;
            --success-green: #10B981;
            --failure-red: #EF4444;
            --muted-text: #6B7280;
            --border-color: #1F2937;
            --header-bg: #12213A;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            transition: background-color 0.3s;
        }

        .dark-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        /* Custom scrollbar style for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        .install-prompt-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            padding: 12px;
            display: none; /* Controlled by PWA JS */
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-[var(--primary-bg)]">
    <div id="root"></div>

    <!-- PWA Install Modal HTML Injection Point -->
    <div id="pwa-install-modal-container"></div>
    
    <!-- PWA INSTALLATION JAVASCRIPT LOGIC (Adapted for Exness Bot) -->
    <script>
        // --- PWA Configuration (Modified for Exness Bot) ---
        const PWA_CACHE_NAME = 'exness-bot-pwa-v1';
        // IMPORTANT: Include both index.html and AI-Trading-Bot.html for offline use
        const PWA_PRECACHE_URLS = ['/', '/index.html', '/AI-Trading-Bot.html']; 
        const PWA_APP_NAME = 'Exness Auto-Trading Bot';
        const PWA_APP_SHORT_NAME = 'Exness Bot';
        const PWA_THEME_COLOR = '#0D1321';
        const PWA_BACKGROUND_COLOR = '#0D1321'; 
        // Placeholder Icon URL (Must be PNG/Non-SVG as requested)
        const PWA_ICON_PNG_URL = 'https://placehold.co/512x512/0077B6/ffffff?text=EXN+BOT'; 

        // --- PWA Installation Script Start (Logic based on user provided functions) ---
        (function initPWAInstaller() {
            'use strict'; 

            /* =========================
               Configuration & State
               ========================= */
            const CACHE_NAME = PWA_CACHE_NAME;
            const PRECACHE_URLS = PWA_PRECACHE_URLS;
            const APP_NAME = PWA_APP_NAME;
            const APP_SHORT_NAME = PWA_APP_SHORT_NAME;
            const THEME_COLOR = PWA_THEME_COLOR;
            const BACKGROUND_COLOR = PWA_BACKGROUND_COLOR; 
            const ICON_PNG_URL = PWA_ICON_PNG_URL; 

            let deferredPrompt = null;
            let isAppInstalled = false;
            let manifestBlobUrl = null;
            let swRegistration = null; 

            /* =========================
               Small DOM helpers
               ========================= */
            function $ (id) { return document.getElementById(id); }
            function createEl (tag, props = {}, children = []) {
                const el = document.createElement(tag);
                Object.keys(props).forEach(k => {
                    if (k === 'style') Object.assign(el.style, props[k]);
                    else if (k === 'attrs') Object.keys(props.attrs).forEach(a => el.setAttribute(a, props.attrs[a]));
                    else el[k] = props[k];
                });
                (Array.isArray(children) ? children : [children]).forEach(c => {
                    if (typeof c === 'string') el.appendChild(document.createTextNode(c));
                    else if (c) el.appendChild(c);
                });
                return el;
            } 

            /* =========================
               Manifest Management
               ========================= */
            function ensureManifest() {
                try {
                    const existing = document.querySelector('link[rel="manifest"]');
                    if (existing) existing.parentNode.removeChild(existing); 

                    const manifest = {
                        name: APP_NAME,
                        short_name: APP_SHORT_NAME,
                        start_url: '/index.html',
                        scope: '/',
                        display: 'standalone',
                        orientation: 'portrait',
                        theme_color: THEME_COLOR,
                        background_color: BACKGROUND_COLOR,
                        icons: [
                            // Using the required PNG icon URL for all sizes
                            { src: ICON_PNG_URL, sizes: '192x192', type: 'image/png', purpose: 'any' },
                            { src: ICON_PNG_URL, sizes: '512x512', type: 'image/png', purpose: 'maskable any' }
                        ],
                        description: 'Exness Auto-Trading Bot - Connect, trade, and automate your portfolio.'
                    }; 

                    const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                    manifestBlobUrl = URL.createObjectURL(blob);
                    const link = createEl('link', { attrs: { rel: 'manifest', href: manifestBlobUrl }});
                    document.head.appendChild(link);
                    console.info('PWA manifest injected/updated.');
                } catch (err) {
                    console.error('Failed to create manifest:', err);
                }
            } 

            /* =========================
               Service Worker Registration
               ========================= */
            async function registerServiceWorker() {
                if (!('serviceWorker' in navigator)) {
                    console.warn('Service Worker not supported.');
                    return null;
                } 

                // Fallback to inline worker: caches specified resources, handles fetch, and posts messages
                const swCode = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const PRECACHE = ${JSON.stringify(PRECACHE_URLS)}; 
                    
                    self.addEventListener('install', (evt) => {
                        evt.waitUntil((async () => {
                            try {
                                const c = await caches.open(CACHE_NAME);
                                await c.addAll(PRECACHE);
                                console.log('Precached:', PRECACHE);
                            } catch (e) {
                                console.error('Precaching failed:', e);
                            }
                            self.skipWaiting();
                        })());
                    }); 

                    self.addEventListener('activate', (evt) => {
                        evt.waitUntil((async () => {
                            const keys = await caches.keys();
                            await Promise.all(keys.map(k => k === CACHE_NAME ? Promise.resolve() : caches.delete(k)));
                            await self.clients.claim();
                        })());
                    }); 

                    self.addEventListener('fetch', (evt) => {
                        evt.respondWith((async () => {
                            try {
                                const cache = await caches.open(CACHE_NAME);
                                const cached = await cache.match(evt.request);
                                if (cached) return cached;
                                const response = await fetch(evt.request);
                                if (evt.request.method === 'GET' && response && response.status === 200 && evt.request.url.startsWith(self.location.origin)) {
                                    cache.put(evt.request, response.clone()).catch(()=>{});
                                }
                                return response;
                            } catch (err) {
                                if (evt.request.mode === 'navigate') {
                                    const cache = await caches.open(CACHE_NAME);
                                    // Fallback to index.html if navigating offline
                                    const fallback = await cache.match('/index.html') || cache.match('/'); 
                                    if (fallback) return fallback;
                                }
                                return new Response('Offline', { status: 503, statusText: 'Offline' });
                            }
                        })());
                    }); 

                    self.addEventListener('message', async (evt) => {
                        const data = evt.data || {};
                        if (data && data.type === 'CACHE_URLS' && Array.isArray(data.urls)) {
                            try {
                                const cache = await caches.open(CACHE_NAME);
                                await cache.addAll(data.urls);
                                const cs = await self.clients.matchAll();
                                cs.forEach(c => c.postMessage({ type: 'cached', urls: data.urls }));
                            } catch (e) {
                                const cs = await self.clients.matchAll();
                                cs.forEach(c => c.postMessage({ type: 'cache_failed', error: String(e) }));
                            }
                        }
                    });
                `; 

                try {
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const blobUrl = URL.createObjectURL(blob);
                    const reg = await navigator.serviceWorker.register(blobUrl);
                    swRegistration = reg;
                    console.info('Inline Service Worker registered.');
                    await waitForServiceWorkerReady();
                    return swRegistration;
                } catch (err) {
                    console.error('Failed to register inline Service Worker:', err);
                    return null;
                }
            } 

            function waitForServiceWorkerReady(timeout = 10000) {
                return new Promise((resolve) => {
                    let resolved = false;
                    navigator.serviceWorker.ready.then(reg => {
                        if (!resolved) { resolved = true; swRegistration = reg; resolve(reg); }
                    }).catch(() => {
                        if (!resolved) { resolved = true; resolve(null); }
                    });
                    setTimeout(() => { if (!resolved) { resolved = true; resolve(null); } }, timeout);
                });
            } 

            /* =========================
               Install Modal/UI Management
               ========================= */
            function ensureInstallModalExists() {
                const modalContainer = $('pwa-install-modal-container');
                if (!modalContainer) return;
                
                // Use a different ID for the card to ensure it doesn't conflict with any component
                if ($('exness-pwa-install-modal')) return; 

                const overlay = createEl('div', {
                    id: 'exness-pwa-install-modal',
                    style: {
                        position: 'fixed', inset: '0', display: 'none', alignItems: 'center', justifyContent: 'center',
                        background: 'rgba(0,0,0,0.6)', zIndex: 2147483647
                    }
                }); 

                const card = createEl('div', {
                    id: 'exness-pwa-install-modal-card',
                    style: {
                        width: '380px', maxWidth: '94%', background: PWA_BACKGROUND_COLOR, borderRadius: '14px', padding: '24px',
                        boxShadow: '0 10px 40px rgba(0,0,0,0.8)', fontFamily: 'Inter, sans-serif', color: PWA_THEME_COLOR, border: '1px solid #1F2937'
                    }
                }); 

                // Header row 
                const headerRow = createEl('div', { style: { display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' } });
                const logoImg = createEl('img', {
                    attrs: { src: ICON_PNG_URL, alt: 'App Logo' },
                    style: { width: '56px', height: '56px', borderRadius: '12px', objectFit: 'cover', border: '2px solid rgba(255,255,255,0.1)' }
                });
                const titleBlock = createEl('div', {}, [
                    createEl('div', { innerText: APP_NAME, style: { fontSize: '20px', fontWeight: 800, color: PWA_THEME_COLOR } }),
                    createEl('div', { innerText: 'PWA for Offline Trading', style: { fontSize: '14px', color: '#9CA3AF' } }),
                ]);
                headerRow.appendChild(logoImg);
                headerRow.appendChild(titleBlock); 

                const desc = createEl('div', {
                    innerText: 'Install Exness Auto-Trading Bot for the best experience! Get offline access and a dedicated home-screen app.',
                    style: { fontSize: '15px', marginTop: '6px', color: '#E5E7EB', lineHeight: '1.6' }
                }); 

                // Progress container
                const progressContainer = createEl('div', { id: 'pwa-install-progress', style: { display: 'none', marginTop: '20px' } });
                const progressOuter = createEl('div', { style: { width: '100%', height: '12px', background: '#242933', borderRadius: '6px', overflow: 'hidden' }});
                const progressBar = createEl('div', { id: 'pwa-install-progress-bar', style: { width: '0%', height: '100%', background: PWA_THEME_COLOR, backgroundColor: '#0077B6', transition: 'width 300ms ease' }});
                progressOuter.appendChild(progressBar);
                const progressText = createEl('div', { id: 'pwa-install-progress-text', innerText: 'Ready to install', style: { fontSize: '13px', marginTop: '8px', color: '#9CA3AF' }});
                progressContainer.appendChild(progressOuter);
                progressContainer.appendChild(progressText); 

                // Actions
                const actions = createEl('div', { style: { display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }});
                const cancelBtn = createEl('button', { id: 'cancel-install-btn', innerText: 'Maybe Later', style: {
                    padding: '10px 16px', borderRadius: '10px', border: '1px solid #1F2937', background: '#1F2937', color: '#E5E7EB', cursor: 'pointer', fontWeight: 600
                }});
                const installBtn = createEl('button', { id: 'install-now-btn', innerText: 'Install Now', style: {
                    padding: '10px 16px', borderRadius: '10px', border: '0', background: '#0077B6', color: '#fff', cursor: 'pointer', fontWeight: 800,
                    boxShadow: '0 4px 10px rgba(0, 119, 182, 0.4)'
                }});
                actions.appendChild(cancelBtn);
                actions.appendChild(installBtn); 

                card.appendChild(headerRow);
                card.appendChild(desc);
                card.appendChild(progressContainer);
                card.appendChild(actions); 

                overlay.appendChild(card);
                modalContainer.appendChild(overlay); 

                // Events
                cancelBtn.addEventListener('click', hideInstallModal);
                installBtn.addEventListener('click', onInstallNowClicked);
                overlay.addEventListener('click', (e) => { if (e.target === overlay) hideInstallModal(); });
            } 

            function showInstallModal() {
                ensureInstallModalExists();
                const overlay = $('exness-pwa-install-modal');
                if (!overlay) return;
                overlay.style.display = 'flex';
                
                // Reset UI elements
                const prog = $('pwa-install-progress'); if (prog) prog.style.display = 'none';
                const bar = $('pwa-install-progress-bar'); if (bar) bar.style.width = '0%';
                const text = $('pwa-install-progress-text'); if (text) text.innerText = 'Ready to install';
                const installBtn = $('install-now-btn'); 
                if (installBtn) { 
                    installBtn.innerText = (deferredPrompt ? 'Install Now' : 'Get App'); 
                    installBtn.disabled = false; 
                    installBtn.style.opacity = '1';
                    installBtn.style.background = '#0077B6'; 
                }
                // Hide banner when modal is open
                const banner = $('pwa-install-banner'); if (banner) banner.style.display = 'none';
            } 

            function hideInstallModal() {
                const overlay = $('exness-pwa-install-modal');
                if (!overlay) return;
                overlay.style.display = 'none';
                // Show banner again
                const banner = $('pwa-install-banner'); 
                if (banner && deferredPrompt && !isAppInstalled) banner.style.display = 'flex';
            } 

            async function onInstallNowClicked(e) {
                e && e.preventDefault && e.preventDefault(); 

                const installBtn = $('install-now-btn');
                const cancelBtn = $('cancel-install-btn');
                const progress = $('pwa-install-progress');
                const progressBar = $('pwa-install-progress-bar');
                const progressText = $('pwa-install-progress-text'); 

                if (installBtn) { installBtn.disabled = true; installBtn.style.opacity = '0.7'; installBtn.innerText = 'Installing...'; }
                if (cancelBtn) cancelBtn.disabled = true; 

                if (progress) progress.style.display = 'block';

                // 1. Try Native Prompt
                if (deferredPrompt) {
                    try {
                        deferredPrompt.prompt();
                        const choice = await deferredPrompt.userChoice;
                        deferredPrompt = null; 
                        
                        if (choice.outcome === 'accepted') {
                            if (progressBar) progressBar.style.width = '50%';
                            if (progressText) progressText.innerText = 'Finalizing native install and caching files...';
                            await waitForAppInstalledOrTimeout(12000); // Wait for the 'appinstalled' event
                            await fallbackInstallSequence(progressBar, progressText, 70); // Ensure caching is complete
                            finalizeInstallUI(true);
                            return;
                        } else {
                            // dismissed -> fallback to aggressive caching
                            if (progressBar) progressBar.style.width = '20%';
                            if (progressText) progressText.innerText = 'Install dismissed. Caching for offline access...';
                            await fallbackInstallSequence(progressBar, progressText);
                            finalizeInstallUI(true, 'installed (offline mode)');
                            return;
                        }
                    } catch (err) {
                        console.warn('deferredPrompt.prompt() error. Falling back.', err);
                        // continue to fallback
                    }
                } 

                // 2. Fallback (Register SW and Cache)
                if (progressText) progressText.innerText = 'Starting offline setup...';
                await fallbackInstallSequence(progressBar, progressText);
                finalizeInstallUI(true, 'installed (offline mode)');
            } 

            function finalizeInstallUI(success = true, extraText = '') {
                const installBtn = $('install-now-btn');
                const progressText = $('pwa-install-progress-text'); 
                const banner = $('pwa-install-banner');

                if (installBtn) {
                    installBtn.innerText = success ? 'App Installed!' : 'Install Failed';
                    installBtn.disabled = true;
                    installBtn.style.background = success ? '#10B981' : '#EF4444';
                    installBtn.style.boxShadow = 'none';
                }
                if (progressText) progressText.innerText = success ? `Installation Complete!${extraText ? ' ' + extraText : ''}` : 'Installation failed. Try again.';
                if (banner) banner.style.display = 'none';
                isAppInstalled = !!success; 

                // Show success toast
                try {
                    const toast = createEl('div', { innerText: success ? `${APP_NAME} installed!` : 'Install failed', style: {
                        position: 'fixed', right: '16px', bottom: '16px', background: success ? '#10B981' : '#EF4444', color: '#fff', 
                        padding: '12px 16px', borderRadius: '10px', zIndex: 2147483648, boxShadow: '0 6px 20px rgba(0,0,0,0.4)',
                        fontWeight: '600', transition: 'bottom 0.5s'
                    }});
                    document.body.appendChild(toast);
                    setTimeout(() => toast.style.bottom = '-60px', 3000);
                    setTimeout(() => toast.remove(), 3500);
                } catch (e) {} 

                // Close modal shortly
                setTimeout(hideInstallModal, 1500);
            } 

            async function fallbackInstallSequence(progressBar, progressText, initialProgress = 10) {
                try {
                    if (progressText) progressText.innerText = 'Registering service worker...';
                    if (progressBar) progressBar.style.width = `${initialProgress}%`;
                    
                    const reg = await registerServiceWorker();
                    
                    if (reg && reg.active) {
                        if (progressBar) progressBar.style.width = `${initialProgress + 25}%`;
                        if (progressText) progressText.innerText = 'Caching core app files (index.html, AI-Trading-Bot.html)...';
                        
                        try {
                            reg.active.postMessage({ type: 'CACHE_URLS', urls: PRECACHE_URLS });
                        } catch (e) {
                            // PostMessage may fail, continue to page-side caching
                        }
                        
                        // Also attempt page-side caching to be robust
                        await cacheResourcesFromPage(PRECACHE_URLS);
                        
                        if (progressBar) progressBar.style.width = '90%';
                        if (progressText) progressText.innerText = 'Finalizing app setup...';
                        await new Promise(r => setTimeout(r, 700));
                        maybeShowIOSInstructions();
                    } else {
                        // No SW active: fallback to using Cache API only
                        if (progressBar) progressBar.style.width = `${initialProgress + 40}%`;
                        if (progressText) progressText.innerText = 'Caching app resources (no service worker active)...';
                        await cacheResourcesFromPage(PRECACHE_URLS);
                        if (progressBar) progressBar.style.width = '95%';
                        if (progressText) progressText.innerText = 'Finalizing...';
                        await new Promise(r => setTimeout(r, 600));
                        maybeShowIOSInstructions();
                    }
                } catch (err) {
                    console.error('fallbackInstallSequence error:', err);
                    if (progressText) progressText.innerText = 'Installation failed — offline features may be limited.';
                }
            } 

            async function cacheResourcesFromPage(urls = PRECACHE_URLS) {
                if (!('caches' in window)) return false;
                try {
                    const cache = await caches.open(CACHE_NAME);
                    const toCache = Array.from(new Set((urls || []).filter(u => typeof u === 'string')));
                    await cache.addAll(toCache);
                    return true;
                } catch (err) {
                    console.warn('Failed to cache resources via page:', err);
                    return false;
                }
            }
            
            function maybeShowIOSInstructions() {
                const ua = navigator.userAgent || '';
                // On iOS Safari, provide instructions
                if (/iphone|ipad|ipod/i.test(ua) && !window.matchMedia('(display-mode: standalone)').matches) {
                    const t = $('pwa-install-progress-text');
                    if (t) t.innerText = 'Tap the Share button → Add to Home Screen to install on iOS';
                }
            } 

            function waitForAppInstalledOrTimeout(timeoutMs = 15000) {
                return new Promise((resolve) => {
                    if (isAppInstalled) return resolve();
                    let done = false;
                    function onInstalled() {
                        if (done) return;
                        done = true;
                        window.removeEventListener('appinstalled', onInstalled);
                        resolve();
                    }
                    window.addEventListener('appinstalled', onInstalled);
                    setTimeout(() => {
                        if (done) return;
                        done = true;
                        window.removeEventListener('appinstalled', onInstalled);
                        resolve();
                    }, timeoutMs);
                });
            } 

            function setupGetAppButtons() {
                const handler = (e) => {
                    e && e.preventDefault && e.preventDefault();
                    if (isAppInstalled) {
                        console.log('App is already installed.');
                        return; 
                    }
                    showInstallModal();
                }; 

                // Target the ID used in the React component for the install button
                const ids = ['get-app-btn', 'install-pwa-button', 'install-now-banner-btn'];
                ids.forEach(id => {
                    const el = $ (id) || document.querySelector(`#${id}`);
                    if (el) {
                        try { el.removeEventListener('click', handler); } catch (e) {}
                        el.addEventListener('click', handler);
                    }
                }); 
            } 

            // Initialize function
            function initialize() {
                ensureManifest();
                registerServiceWorker(); // Register immediately for caching capabilities

                // 1) Listen for beforeinstallprompt and capture deferredPrompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    console.info('beforeinstallprompt captured.');
                    // Show banner if not installed
                    const banner = $('pwa-install-banner');
                    if (banner && !isAppInstalled) {
                        banner.style.display = 'flex';
                    }
                }); 

                // 2) App installed event
                window.addEventListener('appinstalled', (evt) => {
                    console.info('PWA installed event received.');
                    isAppInstalled = true;
                    finalizeInstallUI(true);
                    const banner = $('pwa-install-banner');
                    if (banner) banner.style.display = 'none';
                }); 
            }

            // Global helper to expose the modal function to React
            window.pwaInstaller = {
                showInstallModal,
                hideInstallModal,
                isAppInstalled: () => isAppInstalled
            };
            
            // Wait for DOM to be ready to attach handlers
            document.addEventListener('DOMContentLoaded', initialize);
            window.addEventListener('load', setupGetAppButtons);

        })();
    </script>
    
    <!-- REACT COMPONENTS AND LOGIC (Babel) -->
    <script type="text/babel">
        // Import necessary hooks and components
        const { useState, useEffect, useRef, useCallback } = React;
        const { createRoot } = ReactDOM;

        // --- Constants ---
        const EXNESS_LOGO_URL = 'https://placehold.co/150x40/0077B6/ffffff?text=EXNESS+BOT';
        const COINGECKO_API = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false';

        // --- Reusable Components ---

        const LoadingOverlay = ({ isLoading }) => {
            if (!isLoading) return null;
            return (
                <div className="fixed inset-0 bg-[var(--primary-bg)] bg-opacity-95 flex flex-col items-center justify-center z-[5000] transition-opacity duration-500">
                    <svg className="animate-spin h-12 w-12 text-[var(--accent-color)] mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p className="text-xl font-semibold text-white">Starting Auto-Trading Bot...</p>
                    <p className="text-sm text-[var(--muted-text)] mt-2">Preparing connection and synchronizing market data. Please wait 15 seconds.</p>
                </div>
            );
        };

        const DropdownMenu = ({ children, isVisible, onClose }) => {
            if (!isVisible) return null;
            return (
                <div 
                    className="absolute right-0 mt-2 w-56 rounded-xl dark-card shadow-xl z-30"
                    onBlur={onClose} 
                    tabIndex="-1"
                >
                    <div className="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                        {children}
                    </div>
                </div>
            );
        };

        const DropdownItem = ({ label, onClick }) => (
            <a 
                href="#" 
                onClick={(e) => { e.preventDefault(); onClick(); }}
                className="block px-4 py-3 text-sm text-[var(--primary-text)] hover:bg-[var(--primary-bg)] transition-colors duration-150"
                role="menuitem"
            >
                {label}
            </a>
        );
        
        // --- Core Layout Components ---

        const ExnessHeader = ({ onActionClick }) => {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            
            const menuRef = useRef(null);

            const handleMoreOptionsClick = (e) => {
                e.preventDefault();
                setIsMenuOpen(prev => !prev);
            };

            const handleMenuItemClick = (action) => {
                setIsMenuOpen(false);
                onActionClick(action);
            };

            return (
                <header className="sticky top-0 z-40 dark-card bg-[var(--header-bg)] shadow-lg">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                        
                        {/* Logo and Title */}
                        <div className="flex items-center">
                            <img src={EXNESS_LOGO_URL} alt="Exness Logo" className="h-6 sm:h-8 mr-3" />
                            <h1 className="text-xl sm:text-2xl font-extrabold text-[var(--primary-text)] hidden sm:block">
                                Auto-Trading Bot
                            </h1>
                        </div>

                        {/* Navigation and Actions */}
                        <div className="flex items-center space-x-4">
                            
                            {/* Desktop/Tablet Menu Items */}
                            <nav className="hidden md:flex items-center space-x-6 text-sm font-medium text-[var(--muted-text)]">
                                <a href="#" className="hover:text-[var(--primary-text)] transition-colors">Markets</a>
                                <a href="#" className="hover:text-[var(--primary-text)] transition-colors">Strategy</a>
                                <a href="#" className="hover:text-[var(--primary-text)] transition-colors" id="get-app-btn">Get App</a>
                            </nav>
                            
                            {/* Action Buttons */}
                            <button
                                onClick={() => onActionClick('Login ID')}
                                className="px-3 py-1.5 sm:px-4 sm:py-2 bg-transparent text-[var(--accent-color)] border border-[var(--accent-color)] hover:bg-[var(--accent-hover)] hover:text-white rounded-full text-sm font-semibold transition-all shadow-md"
                            >
                                Login ID
                            </button>
                            <button
                                onClick={() => onActionClick('Start Free Trail')}
                                className="px-3 py-1.5 sm:px-4 sm:py-2 bg-[var(--accent-color)] text-white hover:bg-[var(--accent-hover)] rounded-full text-sm font-semibold transition-all shadow-lg"
                            >
                                Start Free Trial
                            </button>

                            {/* More Options / Mobile Menu */}
                            <div className="relative" ref={menuRef}>
                                <button
                                    onClick={handleMoreOptionsClick}
                                    className="p-2 rounded-full bg-[var(--secondary-bg)] hover:bg-[var(--border-color)] text-[var(--primary-text)] md:hidden transition-colors"
                                >
                                    {/* Inline SVG for Menu Icon */}
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                                </button>
                                
                                <DropdownMenu isVisible={isMenuOpen} onClose={() => setIsMenuOpen(false)}>
                                    <DropdownItem label="Connect Portfolio" onClick={() => handleMenuItemClick('Connect Portfolio')} />
                                    <DropdownItem label="Login ID" onClick={() => handleMenuItemClick('Login ID')} />
                                    <DropdownItem label="Support" onClick={() => handleMenuItemClick('Support')} />
                                    <DropdownItem label="Connect Wallet" onClick={() => handleMenuItemClick('Connect Wallet')} />
                                    <div className="border-t border-[var(--border-color)] my-1"></div>
                                    <DropdownItem label="Get App" onClick={() => handleMenuItemClick('Get App')} id="install-pwa-button-mobile" />
                                </DropdownMenu>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        const ExnessFooter = ({ onActionClick }) => (
            <footer className="dark-card bg-[var(--header-bg)] mt-auto border-t border-[var(--border-color)]">
                <div className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-8">
                        <div>
                            <h5 className="text-lg font-semibold mb-3 text-[var(--primary-text)]">Company</h5>
                            <ul className="space-y-2 text-sm text-[var(--muted-text)]">
                                <li><a href="#" className="hover:text-[var(--primary-text)]">About Us</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Partnerships</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Careers</a></li>
                            </ul>
                        </div>
                        <div>
                            <h5 className="text-lg font-semibold mb-3 text-[var(--primary-text)]">Products</h5>
                            <ul className="space-y-2 text-sm text-[var(--muted-text)]">
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Auto Bot (Default)</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Manual Trading</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Pricing</a></li>
                            </ul>
                        </div>
                        <div>
                            <h5 className="text-lg font-semibold mb-3 text-[var(--primary-text)]">Support</h5>
                            <ul className="space-y-2 text-sm text-[var(--muted-text)]">
                                <li><a href="#" className="hover:text-[var(--primary-text)]" onClick={() => onActionClick('Support')}>Live Chat</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">FAQ</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Contact</a></li>
                            </ul>
                        </div>
                        <div>
                            <h5 className="text-lg font-semibold mb-3 text-[var(--primary-text)]">Legal</h5>
                            <ul className="space-y-2 text-sm text-[var(--muted-text)]">
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Terms of Use</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Privacy Policy</a></li>
                                <li><a href="#" className="hover:text-[var(--primary-text)]">Risk Disclosure</a></li>
                            </ul>
                        </div>
                    </div>
                    <div className="mt-10 pt-6 border-t border-[var(--border-color)] text-center text-sm text-[var(--muted-text)]">
                        &copy; {new Date().getFullYear()} Exness Auto-Trading Bot. All rights reserved. Trading carries a high level of risk.
                    </div>
                </div>
            </footer>
        );

        const TradingViewWidget = ({ symbol }) => {
            const container = useRef(null);

            const loadWidget = useCallback(() => {
                if (!container.current || typeof TradingView === 'undefined') return;

                const widgetConfig = {
                    "width": "100%",
                    "height": container.current.clientHeight,
                    "symbol": symbol,
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "rgb(18, 33, 58)",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": container.current.id,
                };
                
                // Clear existing content to prevent duplicates
                container.current.innerHTML = '';
                
                // TradingView is exposed globally by the CDN script
                new TradingView.widget(widgetConfig); 
            }, [symbol]);

            useEffect(() => {
                // Ensure TV script has loaded
                if (typeof TradingView !== 'undefined') {
                    loadWidget();
                } else {
                    // Fallback in case the script loads after component mount
                    const scriptCheck = setInterval(() => {
                        if (typeof TradingView !== 'undefined') {
                            clearInterval(scriptCheck);
                            loadWidget();
                        }
                    }, 500);
                    return () => clearInterval(scriptCheck);
                }
            }, [symbol, loadWidget]);

            return (
                <div 
                    id="tradingview-widget-container" 
                    ref={container} 
                    className="h-full min-h-[320px] rounded-lg overflow-hidden"
                >
                    <div className="text-center text-[var(--muted-text)] pt-16">Loading Live Price Chart for {symbol}...</div>
                </div>
            );
        };

        const MarketDataDisplay = ({ data, onSelectCoin, selectedSymbol }) => {
            if (!data.length) {
                return <div className="p-6 text-center text-[var(--muted-text)]">Loading market data...</div>;
            }

            // Helper to format price change
            const formatChange = (change) => {
                const color = change >= 0 ? 'text-[var(--success-green)]' : 'text-[var(--failure-red)]';
                const sign = change >= 0 ? '▲' : '▼';
                return <span className={`${color} font-medium`}>{sign} {Math.abs(change).toFixed(2)}%</span>;
            };

            // Helper to format currency
            const formatCurrency = (amount) => {
                return amount.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };
            
            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-[var(--border-color)]">
                        <thead className="bg-[var(--primary-bg)] sticky top-0">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-[var(--muted-text)] uppercase tracking-wider">#</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-[var(--muted-text)] uppercase tracking-wider">Coin</th>
                                <th className="px-6 py-3 text-right text-xs font-medium text-[var(--muted-text)] uppercase tracking-wider">Price</th>
                                <th className="px-6 py-3 text-right text-xs font-medium text-[var(--muted-text)] uppercase tracking-wider">24h %</th>
                                <th className="px-6 py-3 text-right text-xs font-medium text-[var(--muted-text)] uppercase tracking-wider hidden sm:table-cell">Mkt Cap</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-[var(--border-color)]">
                            {data.map((coin, index) => (
                                <tr 
                                    key={coin.id} 
                                    className={`cursor-pointer hover:bg-[var(--primary-bg)] transition-colors duration-150 ${coin.symbol.toUpperCase() === selectedSymbol.split(':')[1] ? 'bg-blue-900/40' : ''}`}
                                    onClick={() => onSelectCoin(coin)}
                                >
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-[var(--muted-text)]">{index + 1}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-[var(--primary-text)] flex items-center gap-3">
                                        <img src={coin.image} alt={coin.name} className="h-6 w-6 rounded-full"/>
                                        <span className="font-semibold">{coin.name}</span>
                                        <span className="text-[var(--muted-text)] uppercase text-xs hidden sm:inline">{coin.symbol}</span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-[var(--primary-text)]">
                                        {formatCurrency(coin.current_price)}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right">
                                        {formatChange(coin.price_change_percentage_24h)}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-[var(--muted-text)] hidden sm:table-cell">
                                        {formatCurrency(coin.market_cap)}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const LandingPage = ({ marketData, onActionClick, selectedCoin, setSelectedCoin }) => {
            const initialSymbol = 'BINANCE:BTCUSDT';
            const [selectedSymbol, setSelectedSymbol] = useState(initialSymbol);
            
            const handleSelectCoin = (coin) => {
                // TradingView requires a broker prefix, using BINANCE as a standard CEX proxy
                setSelectedSymbol(`BINANCE:${coin.symbol.toUpperCase()}USDT`);
                setSelectedCoin(coin);
            };

            useEffect(() => {
                if (selectedCoin) {
                    handleSelectCoin(selectedCoin);
                } else if (marketData.length > 0) {
                    // Set initial coin if data loads first
                    handleSelectCoin(marketData[0]);
                }
            }, [marketData, selectedCoin]);

            return (
                <main className="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
                    
                    {/* Hero Section */}
                    <section className="text-center mb-16 pt-8 pb-16 bg-[var(--secondary-bg)] rounded-xl shadow-2xl">
                        <h2 className="text-4xl sm:text-6xl font-extrabold mb-4 leading-tight text-[var(--primary-text)]">
                            Auto-Trading Bot
                        </h2>
                        <h3 className="text-xl sm:text-2xl text-[var(--accent-color)] font-medium mb-8">
                            Automate Your Portfolio with Exness AI
                        </h3>
                        <p className="max-w-3xl mx-auto text-base sm:text-lg text-[var(--muted-text)] mb-10 px-4">
                            Exness Auto-Trading Bot delivers disruptive, low-latency execution across major markets. 
                            Connect your portfolio and let our proprietary AI algorithms trade with surgical precision 24/7. 
                            Experience the future of trading: deep liquidity, tight spreads, and automated performance.
                        </p>
                        
                        <div className="flex justify-center flex-wrap gap-4 px-4">
                            <button
                                onClick={() => onActionClick('Start Free Trail')}
                                className="px-8 py-3 bg-[var(--accent-color)] text-white text-lg font-bold rounded-xl hover:bg-[var(--accent-hover)] transition-all shadow-xl shadow-blue-500/50"
                            >
                                Start Free Trial
                            </button>
                            <button
                                onClick={() => onActionClick('Connect Portfolio')}
                                className="px-8 py-3 bg-[var(--secondary-bg)] text-[var(--primary-text)] text-lg font-bold rounded-xl border border-[var(--accent-color)] hover:bg-blue-900/30 transition-all shadow-lg"
                            >
                                Connect Portfolio
                            </button>
                        </div>
                    </section>

                    {/* Market Overview Section */}
                    <section className="mb-12">
                        <h2 className="text-3xl font-bold mb-8 text-[var(--primary-text)] text-center">
                            Market Overview: Live Prices & Performance
                        </h2>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            {/* TradingView Chart */}
                            <div className="lg:col-span-2 dark-card p-4 rounded-xl shadow-2xl h-96 mb-8 lg:mb-0">
                                <h4 className="text-xl font-semibold mb-3 text-[var(--primary-text)]">
                                    Live Price Performance Chart
                                </h4>
                                <TradingViewWidget symbol={selectedSymbol} />
                            </div>

                            {/* Top Coins List */}
                            <div className="lg:col-span-1 dark-card p-0 rounded-xl shadow-2xl overflow-hidden">
                                <h4 className="text-xl font-semibold mb-4 p-4 text-[var(--primary-text)]">
                                    Top 10 Cryptocurrencies
                                </h4>
                                <MarketDataDisplay 
                                    data={marketData} 
                                    onSelectCoin={handleSelectCoin} 
                                    selectedSymbol={selectedSymbol}
                                />
                            </div>

                        </div>
                    </section>
                    
                </main>
            );
        };
        
        // --- Main App Component ---

        const App = () => {
            const [marketData, setMarketData] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [selectedCoin, setSelectedCoin] = useState(null);
            
            // Fetch Market Data from Coingecko
            useEffect(() => {
                const fetchMarketData = async () => {
                    try {
                        const response = await fetch(COINGECKO_API);
                        if (!response.ok) throw new Error('Failed to fetch market data');
                        const data = await response.json();
                        setMarketData(data);
                        // Default selection to BTC
                        const btc = data.find(c => c.symbol.toLowerCase() === 'btc');
                        if (btc) setSelectedCoin(btc);
                    } catch (error) {
                        console.error('Market data fetch error:', error);
                        // Optionally set an error state here
                    }
                };

                fetchMarketData();
                // Set interval to refresh data every 60 seconds
                const intervalId = setInterval(fetchMarketData, 60000); 
                return () => clearInterval(intervalId);
            }, []);
            
            // Action Handler for Buttons (Login, Trial, etc.)
            const actionHandler = (action) => {
                switch (action) {
                    case 'Start Free Trail':
                    case 'Login ID':
                        // 15-second loading and redirect to AI-Trading-Bot.html
                        setLoadingMessage(`Logging in and redirecting to ${action} area...`);
                        setIsLoading(true);
                        setTimeout(() => {
                            window.location.href = '/AI-Trading-Bot.html';
                        }, 15000); 
                        break;
                    case 'Connect Portfolio':
                        alert("Portfolio connection interface will open here.");
                        break;
                    case 'Support':
                        alert("Support chat will open here. For now: Please email support@exness-bot.com");
                        break;
                    case 'Connect Wallet':
                        alert("Wallet connection modal will pop up here.");
                        break;
                    case 'Get App':
                        // Trigger PWA install modal via global helper
                        if (typeof window.pwaInstaller.showInstallModal === 'function') {
                            window.pwaInstaller.showInstallModal();
                        } else {
                            alert('PWA installation script not fully loaded.');
                        }
                        break;
                    default:
                        console.log(`Unhandled action: ${action}`);
                }
            };
            
            // Show PWA Banner on Load if available
            useEffect(() => {
                const banner = document.getElementById('pwa-install-banner');
                if (banner && window.deferredPrompt && !window.pwaInstaller.isAppInstalled()) {
                    banner.style.display = 'flex';
                }
            }, []);

            return (
                <React.StrictMode>
                    <div className="flex flex-col min-h-screen">
                        <ExnessHeader onActionClick={actionHandler} />
                        
                        {/* Main Content */}
                        <LandingPage 
                            marketData={marketData} 
                            onActionClick={actionHandler} 
                            selectedCoin={selectedCoin}
                            setSelectedCoin={setSelectedCoin}
                        />

                        <ExnessFooter onActionClick={actionHandler} />
                    </div>
                    
                    {/* Floating PWA Install Banner */}
                    <div id="pwa-install-banner" className="install-prompt-banner">
                        <div className="flex-1 min-w-0 text-white font-medium">
                            Install **Exness Auto-Trading Bot** App for offline mode!
                        </div>
                        <button 
                            id="install-now-banner-btn"
                            className="flex-shrink-0 px-4 py-2 bg-[var(--accent-color)] text-white text-sm font-semibold rounded-lg hover:bg-[var(--accent-hover)] transition-colors"
                            onClick={() => actionHandler('Get App')}
                        >
                            Install Now
                        </button>
                    </div>

                    <LoadingOverlay isLoading={isLoading} />
                </React.StrictMode>
            );
        };

        // Render the App
        window.onload = function () {
            const rootEl = document.getElementById('root');
            if (rootEl) {
                createRoot(rootEl).render(<App />);
            } else {
                console.error("Root element not found.");
            }
        };

    </script>
</body>
</html>
